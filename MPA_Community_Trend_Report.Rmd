---
title: "Channel Islands National Park Kelp Forest Monitoring Program"
subtitle: "Kelp Forest Community Trend Report 2005-2019"
output:
  word_document:
    toc: yes
    reference_docx: Meta_Data/template.docx
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding,
  output_dir = "Output_Documents") })
---
```{r Notes, include=FALSE}

# Should plots be colorblind friendly?

# Green ab biomass?

# non-MPA sites included somehow? Maybe 2 sections in report, an MPA comparison and non-MPA specific. Maybe 2 reports??
# 6/29 beginning to think this is a really good idea since this is turning into an MPA report. I think that's okay since it or/and the blob (and differential outcomes) are literally the most significant thing to consider since 2005 but we might also need to do a general report on all the data (basically take out all the MPA parts and run this again?)

# Not enough rugosity data from finescale bathymetry. Consider doing day trips to Anacapa to conduct rugosity surveys at the 6 reference sites to use with models. David has rugosity data from 90's? not enough for MPA comparison but is a start maybe

# Biomass Data... FIXED... 21 missing values (11 have NHSF so using that for density) for Pisaster in 2018/2019. Need to fill database with zeros (WTF?). Tegula started sampling in 2006 so 5016 MPA values instead of 5040. Lithopoma Handbook data management says 1985 (sporadic sampling) what does that mean? 1 m data missing from only RR and only 1985... also RR is missing data from 1 quad of Patiria in 1985. Need to correct in DB.


# Visibility and surge data for fish counts? Stats?

# Understory algae cover and benthic densities... Does benthic invert density or diversity go down when algae cover goes up?
# need to get understory algae from RPC data

# ENSO data... Temp logger data...

# Note for "Notes"... see commented notes in Data Cleaning below for pending things to update and decisions made

# Think about the potential issues of outputs being FSC by month - IE a survey done in june is going to have a lower FSC than a survey done in september. This is within a season and the coefficients look pretty close, so maybe it's not a big deal, but this sounds like maybe not an apples/apples situation. Discussed this with roommates, thought that averaging out the slopes from may-sept might provide a reasonable "season-level" estimate of biomass, given that the SBC model is calculating NPP based on the notion of mass-specific growth rates, and FSC is broken up into submerged and canopy sections (or combined to whole FSC which are the coefficients used here), so while stipe count doesn't increase by much within a season, the total biomass associated with that individual over the summer's growth greatly increases (obviously submerged portion on canopy forming individuals doesn't change much as depth is fixed, but a larger proportion of the individual is on the surface). I think we can basically "convert it to midsummer" using the average coefficient over the season, allowing for between site comparisons within a year. 6/24/20 I did it this way for now as a placeholder 6/30 we think this is defensible

  # 6/30/2020 is this worth splitting hairs over density vs biomass for inverts? I initially say yes because that indicates some size-structure differences (ie recruitment events if you had a density spike but not much biomass change), but maybe we don't care about this as much for inverts, 
  
  # 6/30/2020 calculate biomass ratios inside/outside MPAs like Josh did for fish in his 2016 talk. One could argue that those plots could replace everything we've done for biomass but that doesn't really show the effects of reserve status and island over time like our current GLMMs and plot sets do.
  
  #Similarly, I want to combine the benthic and fish diversity by site and year with kelp biomass, but I don't calculate those until later.    6/24/20 I added this below fish diversity (since that's the first point running from top down where I have the data I want, even though it feels like it should be up here in the "cleanup")
  # 7/9 Diversity and Community Similarity have consumed us and this has become the main thrust of the first part of the results, as of 7/9 we're joining all the diversity and similarity stuff between benthic and fish.

# Cite ONI DATA
```

```{r Data Cleaning, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
source("global_markdown.R")

{ # SST Anomaly ONI and PDO  ----
SST_Anomaly_Index <- readr::read_csv("Tidy_Data_Dont_Touch/SST_Anomaly_Index.csv")

annual_mean_oni <- SST_Anomaly_Index %>% 
  dplyr::select(SurveyYear, Mean_ONI_ANOM) %>% 
  dplyr::distinct(SurveyYear, .keep_all = TRUE)

annual_mean_pdo <- SST_Anomaly_Index %>% 
  dplyr::select(SurveyYear, Mean_PDO_ANOM) %>% 
  dplyr::distinct(SurveyYear, .keep_all = TRUE)
}

{ # Benthic Site level Counts   ----
  Benthic_Counts_Wide <- readr::read_csv("Tidy_Data_Dont_Touch/Benthic_Counts.csv")
}

{ # Benthic Densities   ----
  # used for plotting species which don't have biomass estimates eg lobster
  Benthic_Densities_Wide <- readr::read_csv("Tidy_Data_Dont_Touch/Benthic_Densities.csv") %>%
     mutate(IslandName = gsub(" Island", "", IslandName),
           IslandName = factor(IslandName, levels = MPA_Levels),
           Date = base::as.Date(base::ISOdate(SurveyYear, 1, 1)))
}

{ # Fish Site level Counts ----
  Fish_Counts_Wide <- readr::read_csv("Tidy_Data_Dont_Touch/Fish_Counts.csv")
}

{ # Benthic Plus Fish Counts for Diversity  ----
  All_Community_Counts_Wide <- Fish_Counts_Wide %>%
    dplyr::select(-'Alloclinus holderi', # duplicate fish on quads and RDFC
                  -'Coryphopterus nicholsi', # duplicate fish on quads and RDFC
                  -'Lythrypnus dalli', # duplicate fish on quads and RDFC
                  -'Sebastes') %>% # useless/meaningless category
    full_join(Benthic_Counts_Wide, by = c('IslandCode', 'IslandName', 'SiteCode',
                                   'SiteName','SurveyYear', 'ReserveStatus')) %>%
    mutate(IslandName = gsub(" Island", "", IslandName),
           IslandName = factor(IslandName, levels = MPA_Levels))
}

{ # Benthic Biomass Wide for Models ----
  Benthic_Biomass_Wide <- readr::read_csv("Tidy_Data_Dont_Touch/Benthic_Biomass_Wide.csv")  %>% 
     dplyr::mutate(Date = base::as.Date(base::ISOdate(SurveyYear, 1, 1)))
}

{ # Benthic Biomass Long for Plots  ----
  Benthic_Biomass_Long <- readr::read_csv("Tidy_Data_Dont_Touch/Benthic_Biomass_Long.csv") %>% 
    dplyr::mutate(IslandName = factor(IslandName, levels = MPA_Levels))
}

{ # Fish Biomass Wide for Models   ----
  Fish_Biomass_Wide <- readr::read_csv("Tidy_Data_Dont_Touch/Fish_Biomass_Wide.csv") %>% 
     dplyr::mutate(IslandName = factor(IslandName, levels = MPA_Levels),
                  Date = base::as.Date(base::ISOdate(SurveyYear, 1, 1)))
}

{ # Fish Biomass Long for Plots  ----
  Fish_Biomass_Long <- readr::read_csv("Tidy_Data_Dont_Touch/Fish_Biomass_Long.csv") %>% 
    dplyr::mutate(IslandName = factor(IslandName, levels = MPA_Levels),
                  CommonName = factor(CommonName))
}

{ # RPCs Percent Cover Wide  ----
  RPC_Cover_Wide <- readr::read_csv("Tidy_Data_Dont_Touch/rpcs_Percent_Cover_Wide.csv") %>%
    dplyr::mutate(IslandName = gsub(" Island", "", IslandName), 
                  Date = base::as.Date(base::ISOdate(SurveyYear, 1, 1))) %>%
            dplyr::left_join(annual_mean_oni, by = c("SurveyYear"))
  names(RPC_Cover_Wide) <- str_replace_all(names(RPC_Cover_Wide), c(" " = "_" , "," = "" ))

}

{ # Shannon Index Calculation   ----
  Shannon_Index <- All_Community_Counts_Wide %>%
    dplyr::select(-IslandCode, -IslandName, -SiteCode, -SiteName, 
                  -SurveyYear, -ReserveStatus) %>%
    vegan::diversity()
  
  Diversity <- dplyr::select(All_Community_Counts_Wide, IslandCode, IslandName,
                             SiteCode, SiteName, SurveyYear, ReserveStatus) %>%
    cbind("ShannonIndex" = Shannon_Index) %>%
    dplyr::mutate(Date = base::as.Date(base::ISOdate(SurveyYear, 1, 1)),
                  ReserveStatus = factor(ReserveStatus),
                  IslandName = factor(IslandName, levels = MPA_Levels),
                  IslandName = gsub(" Island", "", IslandName)) %>%
    dplyr::left_join(annual_mean_oni, by = c("SurveyYear"))
}  

{ # 1-Simpsons Index Calculation and Analyses ----
  Simpson_Index <- RPC_Cover_Wide %>%
    dplyr::select(-IslandCode, -IslandName, -SiteCode, -SiteName, 
                  -SurveyYear, -ReserveStatus, -Date, -Mean_ONI_ANOM) %>%
    vegan::diversity(index= "simpson")
  
  Simp_Diversity <- dplyr::select(RPC_Cover_Wide, IslandCode, IslandName,
                             SiteCode, SiteName, SurveyYear, ReserveStatus) %>%
    cbind("SimpsonIndex" = Simpson_Index) %>%
    dplyr::mutate(Date = base::as.Date(base::ISOdate(SurveyYear, 1, 1)),
                  IslandName = gsub(" Island", "", IslandName),
                  IslandName = factor(IslandName, levels = MPA_Levels)) %>%
    dplyr::left_join(annual_mean_oni, by = c("SurveyYear"))
}  

{ # Mixed Data For Random Forest Model     ----
  # (% cover, Count, Biomass, Shannon Index, Simpson Index)
  All_Mixed_Data_Wide <- readr::read_csv("Tidy_Data_Dont_Touch/All_Mixed_Data_Wide.csv") %>% 
    dplyr::left_join(dplyr::select(
      Diversity, SurveyYear, SiteCode, ShannonIndex)) %>% 
    dplyr::left_join(dplyr::select(
      Simp_Diversity, SurveyYear, SiteCode, SimpsonIndex))
}


```

```{r Model Construction and Analyses, include=FALSE}
{ # Diversity Models  ----
  
  div <- car::Anova(
    test = "F",
    lme4::lmer(
      data = Diversity,
      ShannonIndex ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))
  
  simpsons <- car::Anova(
    test = "F",
    lme4::lmer(
      data = Simp_Diversity,
      (1-SimpsonIndex) ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))
  
}

{ # Benthic Biomass Analyses   ---- 
  # comparing biomass by MPA status, Island, ONI, and MPA-Island (analogous to diversity models)
  
  fsc <- car::Anova(
    test = "F", 
    lme4::lmer(
      data = Benthic_Biomass_Wide,
      Macrocystis_pyrifera ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear), 
    ))
  
  strpur <- car::Anova(
    test = "F",
    lme4::lmer(
      data = Benthic_Biomass_Wide,
      Strongylocentrotus_purpuratus ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))
  
  mesfra <- car::Anova(
    test = "F",
    lme4::lmer(
      data = Benthic_Biomass_Wide,
      Strongylocentrotus_franciscanus ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))
  
  pisgig <- car::Anova(
    test = "F",
    lme4::lmer(
      data = Benthic_Biomass_Wide,
      Pisaster_giganteus ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))
  
  pychel <- car::Anova(
    test = "F",
    lme4::lmer(
      data = Benthic_Biomass_Wide,
      Pycnopodia_helianthoides ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))
  
  patmin <- car::Anova(
    test = "F",
    lme4::lmer(
      data = Benthic_Biomass_Wide,
      Patiria_miniata ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))
  
  halruf <- car::Anova(
    test = "F",
    lme4::lmer(
      data = Benthic_Biomass_Wide,
      Haliotis_rufescens ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))
   
  tetaur <- car::Anova(
    test = "F",
    lme4::lmer(
      data = Benthic_Biomass_Wide,
      Tethya_aurantia ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))
  
  # cencor <- car::Anova(
  #   test = "F",
  #   lme4::lmer(
  #     data = Benthic_Biomass_Wide,
  #     Centrostephanus_coronatus ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))
  # 
  # lopchi <- car::Anova(
  #   test = "F",
  #   lme4::lmer(
  #     data = Benthic_Biomass_Wide,
  #     Lophogorgia_chilensis ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))
  # 
  # stymon <- car::Anova(
  #   test = "F",
  #   lme4::lmer(
  #     data = Benthic_Biomass_Wide,
  #     Styela_montereyensis ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))
  # 
  # urtlof <- car::Anova(
  #   test = "F",
  #   lme4::lmer(
  #     data = Benthic_Biomass_Wide,
  #     Urticina_lofotensis ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))
}

{ # Fish Biomass Analyses   ---- 
  
  hyprub <- car::Anova(
    test = "F",
    lme4::lmer(
      data = Fish_Biomass_Wide,
      Hypsypops_rubicundus ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))
  
  halsem <- car::Anova(
    test = "F",
    lme4::lmer(
      data = Fish_Biomass_Wide,
      Halichoeres_semicinctus ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))
  
  sempul <- car::Anova(
    test = "F",
    lme4::lmer(
      data = Fish_Biomass_Wide,
      Semicossyphus_pulcher ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))

}

{ # Benthic Biomass Analyses   ---- 
  # comparing density by MPA status, Island, ONI, and MPA-Island - same as above but for species without biomass estimates (eg lobster, gorgonians, etc)
   
  palint <- car::Anova(
    test = "F",
    lme4::lmer(
      data = Benthic_Densities_Wide,
      Panulirus_interruptus ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))
  
  cencor <- car::Anova(
    test = "F",
    lme4::lmer(
      data = Benthic_Densities_Wide,
      Centrostephanus_coronatus ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))

  lopchi <- car::Anova(
    test = "F",
    lme4::lmer(
      data = Benthic_Densities_Wide,
      Lophogorgia_chilensis ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))
  
  parpar <- car::Anova(
    test = "F",
    lme4::lmer(
      data = Benthic_Densities_Wide,
      Parastichopus_parvimensis ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))

}

{ # Percent Cover Analyses   ---- 
  # comparing cover by MPA status, Island, ONI, and MPA-Island - same as above but for RPC data
  
  cystoseira <- car::Anova(
    test = "F",
    lme4::lmer(
      data = RPC_Cover_Wide,
      Cystoseira ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))
  
  artic <- car::Anova(
    test = "F",
    lme4::lmer(
      data = RPC_Cover_Wide,
      articulated_coralline_algae ~ ReserveStatus * IslandCode + Mean_ONI_ANOM + (1 | SurveyYear)))
} 

{ # P values for text  ----
  div_MPA_p_val <- round(div$`Pr(>F)`[[1]], 3)
  div_Isl_p_val <- round(div$`Pr(>F)`[[2]], 3)
  div_ONI_p_val <- round(div$`Pr(>F)`[[3]], 3)
  div_MPA_Isl_p_val <- round(div$`Pr(>F)`[[4]], 3)
  
  sim_MPA_p_val <- round(simpsons$`Pr(>F)`[[1]], 3)
  sim_Isl_p_val <- round(simpsons$`Pr(>F)`[[2]], 3)
  sim_ONI_p_val <- round(simpsons$`Pr(>F)`[[3]], 3)
  sim_MPA_Isl_p_val <- round(simpsons$`Pr(>F)`[[4]], 3)
  
  fsc_MPA_p_val <- round(fsc$`Pr(>F)`[[1]], 3)
  fsc_Isl_p_val <- round(fsc$`Pr(>F)`[[2]], 3)
  fsc_ONI_p_val <- round(fsc$`Pr(>F)`[[3]], 3)
  fsc_MPA_Isl_p_val <- round(fsc$`Pr(>F)`[[4]], 3)
  
  strpur_MPA_p_val <- round(strpur$`Pr(>F)`[[1]], 3)
  strpur_Isl_p_val <- round(strpur$`Pr(>F)`[[2]], 3)
  strpur_ONI_p_val <- round(strpur$`Pr(>F)`[[3]], 3)
  strpur_MPA_Isl_p_val <- round(strpur$`Pr(>F)`[[4]], 3)
  
  mesfra_MPA_p_val <- round(mesfra$`Pr(>F)`[[1]], 3)
  mesfra_Isl_p_val <- round(mesfra$`Pr(>F)`[[2]], 3)
  mesfra_ONI_p_val <- round(mesfra$`Pr(>F)`[[3]], 3)
  mesfra_MPA_Isl_p_val <- round(mesfra$`Pr(>F)`[[4]], 3)
  
  pisgig_MPA_p_val <- round(pisgig$`Pr(>F)`[[1]], 3)
  pisgig_Isl_p_val <- round(pisgig$`Pr(>F)`[[2]], 3)
  pisgig_ONI_p_val <- round(pisgig$`Pr(>F)`[[3]], 3)
  pisgig_MPA_Isl_p_val <- round(pisgig$`Pr(>F)`[[4]], 3)
  
  pychel_MPA_p_val <- round(pychel$`Pr(>F)`[[1]], 3)
  pychel_Isl_p_val <- round(pychel$`Pr(>F)`[[2]], 3)
  pychel_ONI_p_val <- round(pychel$`Pr(>F)`[[3]], 3)
  pychel_MPA_Isl_p_val <- round(pychel$`Pr(>F)`[[4]], 3)
  
  patmin_MPA_p_val <- round(patmin$`Pr(>F)`[[1]], 3)
  patmin_Isl_p_val <- round(patmin$`Pr(>F)`[[2]], 3)
  patmin_ONI_p_val <- round(patmin$`Pr(>F)`[[3]], 3)
  patmin_MPA_Isl_p_val <- round(patmin$`Pr(>F)`[[4]], 3)
  
  halruf_MPA_p_val <- round(halruf$`Pr(>F)`[[1]], 3)
  halruf_Isl_p_val <- round(halruf$`Pr(>F)`[[2]], 3)
  halruf_ONI_p_val <- round(halruf$`Pr(>F)`[[3]], 3)
  halruf_MPA_Isl_p_val <- round(halruf$`Pr(>F)`[[4]], 3)
  
  tetaur_MPA_p_val <- round(tetaur$`Pr(>F)`[[1]], 3)
  tetaur_Isl_p_val <- round(tetaur$`Pr(>F)`[[2]], 3)
  tetaur_ONI_p_val <- round(tetaur$`Pr(>F)`[[3]], 3)
  tetaur_MPA_Isl_p_val <- round(tetaur$`Pr(>F)`[[4]], 3)
  
  hyprub_MPA_p_val <- round(hyprub$`Pr(>F)`[[1]], 3)
  hyprub_Isl_p_val <- round(hyprub$`Pr(>F)`[[2]], 3)
  hyprub_ONI_p_val <- round(hyprub$`Pr(>F)`[[3]], 3)
  hyprub_MPA_Isl_p_val <- round(hyprub$`Pr(>F)`[[4]], 3)
  
  halsem_MPA_p_val <- round(halsem$`Pr(>F)`[[1]], 3)
  halsem_Isl_p_val <- round(halsem$`Pr(>F)`[[2]], 3)
  halsem_ONI_p_val <- round(halsem$`Pr(>F)`[[3]], 3)
  halsem_MPA_Isl_p_val <- round(halsem$`Pr(>F)`[[4]], 3)
  
  sempul_MPA_p_val <- round(sempul$`Pr(>F)`[[1]], 3)
  sempul_Isl_p_val <- round(sempul$`Pr(>F)`[[2]], 3)
  sempul_ONI_p_val <- round(sempul$`Pr(>F)`[[3]], 3)
  sempul_MPA_Isl_p_val <- round(sempul$`Pr(>F)`[[4]], 3)
  
  palint_MPA_p_val <- round(palint$`Pr(>F)`[[1]], 3)
  palint_Isl_p_val <- round(palint$`Pr(>F)`[[2]], 3)
  palint_ONI_p_val <- round(palint$`Pr(>F)`[[3]], 3)
  palint_MPA_Isl_p_val <- round(palint$`Pr(>F)`[[4]], 3)
  
  cysto_MPA_p_val <- round(cystoseira$`Pr(>F)`[[1]], 3)
  cysto_Isl_p_val <- round(cystoseira$`Pr(>F)`[[2]], 3)
  cysto_ONI_p_val <- round(cystoseira$`Pr(>F)`[[3]], 3)
  cysto_MPA_Isl_p_val <- round(cystoseira$`Pr(>F)`[[4]], 3)
  
  
  artic_MPA_p_val <- round(artic$`Pr(>F)`[[1]], 3)
  artic_Isl_p_val <- round(artic$`Pr(>F)`[[2]], 3)
  artic_ONI_p_val <- round(artic$`Pr(>F)`[[3]], 3)
  artic_MPA_Isl_p_val <- round(artic$`Pr(>F)`[[4]], 3)
  
}

```
```{r Executive Summary, child="Executive_Summary.Rmd", eval=TRUE}
```
```{r Introduction, child="Introduction.Rmd", eval=TRUE}
```
```{r Methods, child="Methods.Rmd", eval=TRUE}
```
# Results

## Community Diversity

### Benthic Invertebrate and Fish Communities - Shannon Index

Our generalized linear mixed model (GLMM) indicated significant effects on benthic and fish community diversity (Shannon Index) of MPA status (P=`r div_MPA_p_val`), Island (P=`r div_Isl_p_val`), their interaction (P=`r div_MPA_Isl_p_val`), and the Oceanic Nino Index (ONI), a measurement of seawater temperature anomaly P=`r div_ONI_p_val`; Table 2). Significant effects of MPA status have occured in recent years (2017-2018, Fig 3 top), whereas Santa Rosa Island had significantly higher diversity than other islands until 2013, then significantly lower diversity after 2016 (Fig 3 middle), occurring just prior to the 2014-15 El Nino event. At Santa Rosa Island, these declines in diversity were more drastic outside of MPA protection than inside (Fig 3 bottom).

Table 2. GLMM Results
```{r Shannon Index Summary Tables (GLMM), results = 'asis'}
knitr::kable(div, caption= "Model Formula: Shannon Index = Reserve Status * Island + ONI + (1 | Survey Year)")
```

```{r Shannon Index Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}
p1 <- ggplot2::ggplot(Diversity, aes(x = Date, y = ShannonIndex, linetype=ReserveStatus)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2) +
  ggplot2::geom_smooth(se = FALSE, aes(color = ReserveStatus)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                linetype = "Reserve Status",
                color = "Reserve Status") +
  timeseries_top_theme()

p2 <- ggplot2::ggplot(Diversity, aes(x = Date, y = ShannonIndex, color = IslandName)) +
  ggplot2::stat_smooth(geom='ribbon', alpha = .2, linetype = 0, 
                       aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..))) +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                color = "Island") +
  timeseries_top_theme()

p3 <- ggplot2::ggplot() +
  geom_rect(data = SST_Anomaly_Index, aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = 0, fill = ONI_ANOM)) +
  scale_fill_gradient2(high = "darkred", mid = "white", low = "navyblue", midpoint = 0,
                       guide = guide_colorbar(direction = "horizontal", title.position = "top",
                                              order = 3, barheight = unit(.2, "cm"))) +
  ggplot2::geom_smooth(data = Diversity, aes(x = Date, y = ShannonIndex, color = IslandName, linetype = ReserveStatus),
                       method = 'loess', formula = 'y~x', se = F) +
  ggplot2::geom_hline(aes(yintercept = 0)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(.1, 0))) +
  ggplot2::guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2, override.aes = list(col = 'black'))) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = "Survey Year", y = NULL,
                color = "Island Code",
                fill = "Oceanic Nino Index",
                linetype = "Reserve Status") +
  timeseries_bottom_theme() 
Diversity_Plot <-ggarrange(p1, p2, p3, ncol = 1, align = "v")
Diversity_annotated <- ggpubr::annotate_figure(
  Diversity_Plot,
  # bottom = text_grob(paste(" Fig 3. Community diversity by reserve status across all reference sites (Top), diversity by island",
  #                          "\n",
  #                          "across all reference sites (Middle), and diversity by island and reserve status across all ",
  #                          "\n",
  #                          "reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing.",
  #                          "\n",
  #                          "Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C."),
  #                    family ="Cambria", color = "black", size = 12, hjust = 0, x = 0),
  left = text_grob("Shannon Index (Diversity)", family ="Cambria", color = "black", rot = 90, size = 13)
)
print(Diversity_annotated)
```
Fig 3. Community diversity by reserve status across all reference sites (Top), diversity by island across all reference sites (Middle), and diversity by island and reserve status across all reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing. Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C.

### Algal and Benthic Cover Communities - Simpson's Index

Our generalized linear mixed model indicated significant effects on algal community diversity (1-Simpson's Index) of MPA status (P=`r sim_MPA_p_val`), Island (P=`r sim_Isl_p_val`), and their interaction (P=`r sim_MPA_Isl_p_val`), however ONI did not significantly affect algal community diversity in our model (P=`r sim_ONI_p_val`; Table 2). Algal diversity inside MPAs became significantly higher than outside MPAs in 2013 (Fig 4 top), just prior to the 2014-15 El Nino event. Between islands, Santa Rosa previously had significantly higher algal diversity, and Santa Barbara had lower diversity, until all islands converged between 2012 and 2014 (Fig 4 middle). Lastly, algal diversity is generally lower outside an MPA than inside, at any given island (Fig 4 bottom).

Table 3. GLMM Results
```{r Simpsons Index Summary Tables (GLMM), results = 'asis'}
knitr::kable(simpsons, caption= "Model Formula: Simpson's Index = Reserve Status * Island + ONI + (1 | Survey Year)")
```

```{r Simpsons Index Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}

p1 <- ggplot2::ggplot(Simp_Diversity, aes(x = Date, y = SimpsonIndex, linetype=ReserveStatus)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2) +
  ggplot2::geom_smooth(se = FALSE, aes(color = ReserveStatus)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                linetype = "Reserve Status",
                color = "Reserve Status") +
  timeseries_top_theme()

p2 <- ggplot2::ggplot(Simp_Diversity, aes(x = Date, y = SimpsonIndex, color = IslandName)) +
  ggplot2::stat_smooth(geom='ribbon', alpha = .2, linetype = 0, 
                       aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..))) +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                color = "Island") +
  timeseries_top_theme()

p3 <- ggplot2::ggplot() +
  geom_rect(data = SST_Anomaly_Index, aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = 0, fill = ONI_ANOM)) +
  scale_fill_gradient2(high = "darkred", mid = "white", low = "navyblue", midpoint = 0,
                       guide = guide_colorbar(direction = "horizontal", title.position = "top",
                                              order = 3, barheight = unit(.2, "cm"))) +
  ggplot2::geom_smooth(data = Simp_Diversity, aes(x = Date, y = SimpsonIndex, color = IslandName, linetype = ReserveStatus),
                       method = 'loess', formula = 'y~x', se = F) +
  ggplot2::geom_hline(aes(yintercept = 0)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(.1, 0))) +
  ggplot2::guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2, override.aes = list(col = 'black'))) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = "Survey Year", y = NULL,
                color = "Island Code",
                fill = "Oceanic Nino Index",
                linetype = "Reserve Status") +
  timeseries_bottom_theme() 
Simp_Diversity_Plot <-ggarrange(p1, p2, p3, ncol = 1, align = "v")
Simp_Diversity_annotated <- ggpubr::annotate_figure(
  Simp_Diversity_Plot,
  # bottom = text_grob(paste(" Fig 4. Simpson's diversity by reserve status across all reference sites (Top), diversity by island",
  #                          "\n",
  #                          "across all reference sites (Middle), and diversity by island and reserve status across all ",
  #                          "\n",
  #                          "reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing.",
  #                          "\n",
  #                          "Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C."),
  #                    family ="Cambria", color = "black", size = 12, hjust = 0, x = 0),
  left = text_grob("Simpson's Index (Diversity)", family ="Cambria", color = "black", rot = 90, size = 13)
)
print(Simp_Diversity_annotated)
```
Fig 4. Simpson's diversity by reserve status across all reference sites (Top), diversity by island across all reference sites (Middle), and diversity by island and reserve status across all reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing. Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C.

## Community Similarity

Communities were significantly different at Santa Rosa Island between 2005 and 2010 (P < 0.001), before converging with the cluster comprised of Santa Cruz, Anacapa, and Santa Barbara Islands from 2012-2015, concurrent with the 2014-15 El Nino event (Fig 5), indicated by lower R values. However, these groupings were still statistically significant (0.005 < p < 0.001 for 2010-2015, Fig 5). Following 2015, the communities at Santa Rosa Island again become more distinctly separate, but the overlap between Santa Cruz, Anacapa, and Santa Barbara islands is higher than prior to the El Nino event (Fig 5). Lastly, the timing of these changes in community similarity at Santa Rosa Island coincides with the changes in diversity at Santa Rosa Island (Fig 4, Fig 5).

```{r Community Similarity (nMDS plot, stress, ANOSIM) Calculations, warning= FALSE, message= FALSE, include=FALSE, fig.keep='none'}
anosim_table <- data.frame(Year = integer(), P_val = double(), R_statistic = double())
for (k in unique(All_Community_Counts_Wide$SurveyYear)) {
  nMDS_Table <- All_Community_Counts_Wide %>%
    filter(SurveyYear %in% k)  %>%
    arrange(IslandName) %>% 
    droplevels()
  
  nMDS <- nMDS_Table %>%
    dplyr::select(-IslandCode, - IslandName, -SiteCode, -SiteName, - SurveyYear, - ReserveStatus) %>%
    metaMDS(k = 2, trymax = 100)
  stress_score <- nMDS$stress
  
  data_scores <- as.data.frame(scores(nMDS))
  data_scores$site <- nMDS_Table$SiteCode
  data_scores$island <- nMDS_Table$IslandName
  data_scores$reserve <- nMDS_Table$ReserveStatus
  
  plot.new() #this is here because ordiellipse pops an error that plot.new() hasn't been opened yet
  ellipses <- ordiellipse(nMDS, nMDS_Table$IslandName, display = "sites", kind = "sd", conf = 0.95, label = T)
  
  df_ellipse <- data.frame()
  veganCovEllipse <- function (cov, center = c(0, 0), scale = 1, npoints = 100) 
  {
    theta <- (0:npoints) * 2 * pi/npoints
    Circle <- cbind(cos(theta), sin(theta))
    t(center + scale * t(Circle %*% chol(cov)))
  }
  
  for(g in unique(nMDS_Table$IslandName)){
    df_ellipse <- rbind(df_ellipse, 
                        cbind(as.data.frame(with(
                          nMDS_Table[nMDS_Table$IslandName == g,],
                          veganCovEllipse(ellipses[[g]]$cov, ellipses[[g]]$center, ellipses[[g]]$scale))),
                          IslandName=g))
  }
  
  anosim_output <- nMDS_Table %>%
    dplyr::select(-IslandCode, -IslandName, -SiteCode, -SiteName, -SurveyYear, -ReserveStatus) %>%
    anosim(nMDS_Table$IslandName)
  
  anosim_table <- anosim_table %>%
    add_row(Year = k, P_val = anosim_output$signif, R_statistic= anosim_output$statistic)
  
  nMDS.plot <- ggplot() + 
    geom_path(data = df_ellipse, size = 1, 
              aes(x = NMDS1, y = NMDS2, color = IslandName)) +
    geom_point(data = data_scores, size = 2, 
               aes(x = NMDS1, y = NMDS2, shape = reserve, colour = island)) + 
    geom_text(data = data_scores, size = 2, vjust = 2, 
              aes(x = NMDS1, y = NMDS2, label = site)) +  
    scale_colour_manual(values = Island_Colors) +
    coord_fixed() +
    labs(title = glue("{k}"), 
         caption = glue::glue("P-Value: {round(anosim_output$signif, 3)}  R: {round(anosim_output$statistic, 3)}"),
         color = "Island",
         shape = "Reserve Status") +
    nMDS_theme()
  
  print(nMDS.plot)
  unique_plotname <- paste("nMDS.plot.", k, sep = "")
  assign(unique_plotname, nMDS.plot)
}
```

```{r Community Similarity Plots (nMDS) and statistical results (ANOSIM), warning=FALSE, message=FALSE, fig.height=7.5, fig.width=10}
nMDS_Plot1 <- ggpubr::ggarrange(
  nMDS.plot.2005, nMDS.plot.2006, nMDS.plot.2007, nMDS.plot.2008, nMDS.plot.2009,
  nMDS.plot.2010, nMDS.plot.2011, nMDS.plot.2012, nMDS.plot.2013, nMDS.plot.2014,
  nMDS.plot.2015, nMDS.plot.2016, nMDS.plot.2017, nMDS.plot.2018, nMDS.plot.2019,
  ncol = 5, nrow = 3, common.legend = TRUE, legend = "bottom", align = "hv")

nMDS_annotated1 <- ggpubr::annotate_figure(
  nMDS_Plot1) 
  # bottom = ggpubr::text_grob(
  #   paste(" Fig 5. nMDS plots for community similarity from 2005-2019, grouped by island. Symbols represent reserve status, ellipses represent 95% confidence regions,",
  #         "\n",
  #         "ANOSIM R statistics and P-values are shown."),
  #   color = "black", size = 11, hjust = 0, x = 0))

print(nMDS_annotated1)
```
Fig 5. nMDS plots for community similarity from 2005-2019, grouped by island. Symbols represent reserve status, ellipses represent 95% confidence regions, ANOSIM R statistics and P-values are shown.

## Species Importance
### Random Forest 

Random Forest analysis ranked variables by their importance to correctly classifying the data based on reserve status, based on mean decreases in accuracy (in percent), as well as the Gini index, which measures data impurity (a low Gini index indicates few misclassifications). In terms of model accuracy, the 10 most important variables included Parastichopus parvimensis (warty sea cucumber), Panulirus interruptus (California spiny lobster), Kelletia kelletii (Kellet's whelk), Hypsypops rubicundus (Garibaldi), Simpson's Index, Cystoseira osmundacea (chainbladder kelp), Tethya aurantia (orange puffball sponge), Strongylocentrotus franciscanus (red urchin), Stronglyocentrotus purpuratus (purple urchin), and articulated coralline algae. Partial importance plots indicate the values at which a variable consistently classified to either level of reserve status (inside or outside-MPA); the top 30 species for accuracy decrease and Gini index are shown (Fig 6), along with their respective partial importance plots (Fig 7).

```{r Random Forest, fig.height=8.5, fig.width=11}
Random_Kelp_Forest <- All_Mixed_Data_Wide %>%
  dplyr::rename("KGBC_YOY" = `Sebastes_atrovirens/carnatus/caurinus/chrysomelas`,
                "OY_YOY" = `Sebastes_serranoides/flavidus`,
                "BG_YOY" = `Sebastes_chrysomelas/carnatus`,
                "Misc_Invert" = `Miscellaneous_Invertebrates_excluding_Ophiothrix_spiculata`) %>%
  dplyr::mutate(SiteCode = factor(SiteCode, levels = siteInfo1$SiteCode),
                IslandCode = factor(IslandCode),
                ReserveStatus = factor(ReserveStatus)) %>% 
  dplyr::select(-SiteName, 
                # -IslandName,
                -IslandCode,
                -SiteCode) 

set.seed(100)
train <- sample(nrow(Random_Kelp_Forest), 
                0.7 * nrow(Random_Kelp_Forest), replace = FALSE)

TrainSet <- Random_Kelp_Forest[train,]
ValidSet <- Random_Kelp_Forest[-train,]

RF_Reserve_Model <- randomForest::randomForest(
  data = Random_Kelp_Forest,
  ReserveStatus ~ ., ntree = 3000, mtry = 8,
  importance = TRUE, proximity = TRUE, keep.forest = TRUE)

# Predicting on train set
predTrain <- predict(RF_Reserve_Model, TrainSet, type = "class")
# Checking classification accuracy
table(predTrain, TrainSet$ReserveStatus) 
# Predicting on Validation set
predValid <- predict(RF_Reserve_Model, ValidSet, type = "class")
# Checking classification accuracy
mean(predValid == ValidSet$ReserveStatus)                    
table(predValid, ValidSet$ReserveStatus)

# RF_Reserve_Model
```

```{r RF Error and Importance, fig.height=7.5, fig.width=10}
# plot(RF_Reserve_Model, log="y")
randomForest::varImpPlot(RF_Reserve_Model, n.var = 30, main= "")
```
Fig 6. Variable Importance plots displaying the 30 most important variables to successfully predicting reserve status, based on mean decrease in accuracy (left) and Gini Index (a measure of data impurity where a low Gini index represents few misclassifications; right).

```{r RF Partial Importance, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}
RF_Importance <- importance(RF_Reserve_Model) %>%
  as.data.frame() %>%
  tibble::rownames_to_column("ScientificName") %>%
  dplyr::arrange(desc(MeanDecreaseAccuracy)) 

Important_Variables <- RF_Importance$ScientificName[1:30] # <== Choose the top number of variables

Mixed_Data_xRef <- readr::read_csv("Meta_Data/Mixed_Data_xref.csv") %>% 
  dplyr::filter(ScientificName %in% Important_Variables)
q <- 1
for (i in seq_along(Important_Variables)) {
  a <- partial(RF_Reserve_Model, 
               pred.var = Important_Variables[i], 
               train = Random_Kelp_Forest,
               plot = TRUE, rug = TRUE, 
               plot.engine = "ggplot2") +
    labs(title = gsub("_", " ", Important_Variables[i]), 
         x = Mixed_Data_xRef[i, 2], y = NULL) +
    theme_classic() +
    theme(plot.title = element_text(hjust = .5, size = 10),
          axis.title = element_text(size = 9))
  unique_plotname <- paste("PDP_", q, sep = "")
  assign(unique_plotname, a)
  q <- q + 1
}

PDP_Grid_1 <- ggpubr::ggarrange(
  PDP_1, PDP_2, PDP_3,
  PDP_4, PDP_5, PDP_6,
  PDP_7, PDP_8, PDP_9,
  PDP_10, PDP_11, PDP_12,
  PDP_13, PDP_14, PDP_15,
  ncol = 3, nrow = 5, align = "v")

PDP_Grid_2 <- ggpubr::ggarrange(
  PDP_16, PDP_17, PDP_18,
  PDP_19, PDP_20, PDP_21,
  PDP_22, PDP_23, PDP_24,
  PDP_25, PDP_26, PDP_27,
  PDP_28, PDP_29, PDP_30,
  ncol = 3, nrow = 5, align = "v")

PDP_annotated1 <- ggpubr::annotate_figure(
  PDP_Grid_1)
  # bottom = ggpubr::text_grob(
  #   "Lines that trend upwards indicate importance of variable in determining 'inside' reserve status\nLines that trend downwards indicate importance of variable in determining 'outside' reserve status",
  #   color = "black", size = 11, hjust = 0, x = 0))

PDP_annotated2 <- ggpubr::annotate_figure(
  PDP_Grid_2)
  # bottom = ggpubr::text_grob(
  #   "Lines that trend upwards indicate importance of variable in determining 'inside' reserve status\nLines that trend downwards indicate importance of variable in determining 'outside' reserve status",
  #   color = "black", size = 11, hjust = 0, x = 0))

print(PDP_annotated1)
print(PDP_annotated2)

```
Fig 7. Partial importance plots for the top 30 species based on mean decreases in accuracy. Since the response variable is categorical, and the possible results are either "in" or "out", lines converge either at the top or bottom of the plot and the value where convergence occurs indicates the break point across which the model classifies an observation as inside or outside-MPA. 

### Indicator Species Analysis

Indicator Species analysis identified several species that were significant indicators to only inside, or outside MPA communities, as well as several which were indicators for both types of communities within an island. For the fish community at Santa Rosa Island, Embiotoca lateralis (striped surfperch), Sebastes atrovirens (Kelp rockfish), S. chrysomelas (Black and Yellow rockfish), and S. serranoides (Olive rockfish) were indicator species for both inside- and outside-MPA communities for most years, while Oxyliebus pictus (painted greenling) have been indicator species consistently since 2014/15 (Fig 6). The Santa Rosa Island invertebrate community similarly had indicator species consistent between reserve statuses; Urticina lofotensis (white-spotted rose anemone) was a significant indicator species for all years in both communities (Fig 6). Additional invertebrate indicator species include Tethya aurantia (orange puffball sponge), which was significant for all years except 2011-2012 outside of MPAs, but significant only in 2005, 2006, 2008, and 2018-2019 inside MPAs (Fig 6). Pycnopodia helianthoides (sunflower star) was significant for both reserve statuses every year until 2013, while Strongylocentrotus purpuratus and Mesocentrotus franciscanus (purple and red urchins, respectively) began consistently indicating inside-MPA communities since 2015, and also outside-MPA communities in 2016-2018 (purples) and 2018 (reds; Fig 6). Patiria miniata (bat star) were significant for every year inside MPA communities, but only in 2013, and 2015-2018 outside of MPAs (Fig 6).  Lastly, Pterygophora californica was a significant algal indicator species for outside-MPA communities for most years, until 2014 (Fig 6). 

For Santa Cruz Island, the fish community inside MPAs was indicated by Halichoeres simicinctus (rock wrasse) in 2005-2008, 2010-2011, and 2016, whereas it indicated outside-MPA comunities in 2006-2007, and 2009 (Fig 7). Hypsypops rubicundus (Garibaldi) were indicators for outside-MPA communities in 2005, 2008, and 2013, whereas they never indicated inside-MPA communities at Santa Cruz island (Fig 7). Lythrypnus dalli (blue-banded goby) has recently (since 2016) indicated outside-MPA communities, whereas they indicated inside-MPAs only in 2016, indicating a possible recruitment event in that year. For the invertebrate community, Lophogorgia chilensis (red gorogonian) has indicated outside-MPA communities at Santa Cruz Island for all years except 2019, but has not been an indicator species in any year for inside-MPA communities (Fig 7). Lastly, Sargassum horneri, an invasive species, indicated the outside-MPA communities at Santa Cruz in 2019 (Fig 7).

Anacapa Island exhibited similar trends to Santa Cruz Island overall, the fish community inside-MPAs was significantly indicated by H. simicinctus in 2006-2008, 2010-2011, 2014, and 2016, whereas they also indicated outside-MPA communities in 2006-2007, and 2009 (Fig 8). The outside-MPA community at Anacapa was indicated by Centrostephanus coronatus (coronado urchin), Muricea fruticosa (brown gorogonian), and Muricea californica (california golden gorogonian) for most years analysed, whereas these species never indicated inside-MPA communities (Fig 8). Similar to Santa Cruz Island, S. horneri also indicated outside-MPA communities at Anacapa for 2019 (Fig 8). 

Lastly, communities at Santa Barbara Island showed similar trends to the other warmer islands (Santa Cruz and Anacapa) for fish communities; H. rubicundus indicated outside-MPA communities in 2005, 2009, and 2013, but never indicated inside-MPA communities (Fig 9). However, the invertebrate community inside-MPAs was significantly indicated by M. californica every year until 2018, but M. californica never indicated outside-MPA communities (Fig 9), the opposite pattern from Anacapa Island. Tegula regina (Queen Tegula) indicated outside-MPA communities in 2006, 2008-2011, 2013-2016, but never indicated inside-MPA communities (Fig 9).

```{r Indicator Species Analysis, warning=FALSE, message=FALSE, fig.height=7.5, fig.width=10}
indic_spp_table <- dplyr::data_frame(ScientificName = character(), s.SR = double(), s.SC = double(), s.AN = double(), s.SB = double(),
                                     index = integer(), stat = double(), p.value = double(), Year = integer(), ReserveStatus = character())
for (h in base::unique(All_Community_Counts_Wide$ReserveStatus)) {
  for (k in base::unique(All_Community_Counts_Wide$SurveyYear)) {
    Indic_Spp <- All_Community_Counts_Wide %>%
      dplyr::filter(ReserveStatus %in% h) %>%
      dplyr::rename('KGBC YOY' = 'Sebastes atrovirens/carnatus/caurinus/chrysomelas')%>%  
      dplyr::filter(SurveyYear %in% k) %>%
      dplyr::select(-IslandCode, - IslandName, -SiteCode, -SiteName, - SurveyYear, - ReserveStatus) %>%
      indicspecies::multipatt(multipatt_island_list, func = "r.g", control = how(nperm = 1000)) %>% 
      .$sign %>%
      tibble::rownames_to_column("ScientificName") %>%
      dplyr::mutate(Year = k, ReserveStatus = h) %>%
      dplyr::filter(p.value < 0.05) 
    indic_spp_table <- base::rbind(indic_spp_table, Indic_Spp)
  }
}

indic_sites <- c("s.SR", "s.SC", "s.AN", "s.SB")
for (h in base::unique(All_Community_Counts_Wide$ReserveStatus)) {
  for (i in indic_sites) {
    Spp_List <- indic_spp_table %>%
      dplyr::filter(!!as.symbol(i) == 1, ReserveStatus %in% h) %>%
      .$ScientificName %>%
      base::unique() 
    
    unique_spplist <- base::paste(h, i, "_Spp_List", sep = "")
    base::assign(unique_spplist, Spp_List)
  }
}

heat_map_data <- base::data.frame(ScientificName = character(), stat = double(), p.value = double(), year = integer(), IslandName = character(), ReserveStatus = character())
for (h in base::unique(All_Community_Counts_Wide$ReserveStatus)) {
  for (z in indic_sites) {
    Spp_Scores <- indic_spp_table %>%
      dplyr::filter(!!as.symbol(z) == 1, ReserveStatus %in% h) %>%
      dplyr::mutate(IslandName = z, ReserveStatus = h)
    heat_map_data <- heat_map_data %>%
      base::rbind(Spp_Scores)
  }
}
heat_map_data <- dplyr::select(heat_map_data, ScientificName, stat, p.value, Year, IslandName, ReserveStatus)

Outside_Heat_Species <- base::rep(c(Outsides.SR_Spp_List, Outsides.SC_Spp_List, Outsides.AN_Spp_List, Outsides.SB_Spp_List), 
                                  times = base::length(unique(heat_map_data$Year)))
Inside_Heat_Species <- base::rep(c(Insides.SR_Spp_List, Insides.SC_Spp_List, Insides.AN_Spp_List, Insides.SB_Spp_List), 
                                 times = base::length(unique(heat_map_data$Year)))

Outside_Heat_Sites <- base::rep(c((base::rep("s.SR", each = length(Outsides.SR_Spp_List))), 
                                  (base::rep("s.SC", each = base::length(Outsides.SC_Spp_List))), 
                                  (base::rep("s.AN", each = base::length(Outsides.AN_Spp_List))), 
                                  (base::rep("s.SB", each = base::length(Outsides.SB_Spp_List)))),
                                times = base::length(base::unique(heat_map_data$Year)))
Inside_Heat_Sites <- base::rep(c((base::rep("s.SR", each = length(Insides.SR_Spp_List))), 
                                 (base::rep("s.SC", each = base::length(Insides.SC_Spp_List))), 
                                 (base::rep("s.AN", each = base::length(Insides.AN_Spp_List))), 
                                 (base::rep("s.SB", each = base::length(Insides.SB_Spp_List)))),
                               times = base::length(base::unique(heat_map_data$Year)))

Outside_Heat_Year <- base::rep((base::unique(heat_map_data$Year)), each = 
                                 ((base::length(Outsides.SR_Spp_List))+
                                    (base::length(Outsides.SC_Spp_List))+
                                    (base::length(Outsides.AN_Spp_List))+
                                    (base::length(Outsides.SB_Spp_List))))
Inside_Heat_Year <- base::rep((base::unique(heat_map_data$Year)), each = 
                                ((base::length(Insides.SR_Spp_List))+
                                   (base::length(Insides.SC_Spp_List))+
                                   (base::length(Insides.AN_Spp_List))+
                                   (base::length(Insides.SB_Spp_List))))

Outside_full_heat_table <-  base::data.frame(
  IslandName = Outside_Heat_Sites, Year = Outside_Heat_Year, 
  ScientificName = Outside_Heat_Species, ReserveStatus = "Outside")
Inside_full_heat_table <-  base::data.frame(
  IslandName = Inside_Heat_Sites, Year = Inside_Heat_Year, 
  ScientificName = Inside_Heat_Species, ReserveStatus = "Inside")

full_heat_table <- rbind(Outside_full_heat_table, Inside_full_heat_table)

short_names <- Species_Info %>% 
  dplyr::select(ScientificName, ScientificName_Short_Form, Classification, Class_Short) %>% 
  dplyr::filter(ScientificName %in% unique(indic_spp_table$ScientificName)) %>% 
  dplyr::distinct()

heat_map <- dplyr::left_join(full_heat_table, heat_map_data, by=c("IslandName", "Year", "ScientificName", "ReserveStatus")) %>%
  dplyr::mutate(IslandName = dplyr::recode_factor(
    IslandName, s.SR ="Santa Rosa Island", s.SC ="Santa Cruz Island",
    s.AN ="Anacapa Island", s.SB ="Santa Barbara Island")) %>% 
  dplyr::group_by(IslandName, ScientificName, ReserveStatus) %>% 
  dplyr::mutate(frequency = length(stat[!is.na(stat)])) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(short_names) %>%
  dplyr::arrange(desc(Class_Short), desc(frequency), desc(ReserveStatus)) 

fig_counter <- 8
for(i in unique(heat_map$IslandName)) {
  Island_Heat_Data <- heat_map %>% 
    dplyr::filter(IslandName == i) 
  
  Island_Heat_Data$ScientificName_Short_Form =  fct_rev(factor(Island_Heat_Data$ScientificName_Short_Form,
                                                               levels = unique(Island_Heat_Data$ScientificName_Short_Form)))
  Island_Heat_Data$Classification =  factor(Island_Heat_Data$Classification,
                                            levels = c("Fish", "Invertebrates", "Algae"))
  p <- ggplot() +
    geom_tile(data = Island_Heat_Data,
              aes(x = Year, y = ScientificName_Short_Form, fill = stat), color="black") +
    ggplot2::scale_x_continuous(breaks = 2005:Year_to_Filter_Data_by, expand = c(0,0)) +
    ggplot2::scale_y_discrete(expand = c(0,0)) +
    ggplot2::scale_fill_gradient2(low = scales::muted("lightgreen"), 
                                  high = "forestgreen", na.value = scales::muted("firebrick")) + 
    ggplot2::facet_grid(rows = vars(Classification), cols = vars(ReserveStatus), scales = "free", space = "free") +
    ggplot2::labs(title = i, x = "Year", y = "Species/Taxa", 
                  fill = paste("Strength of", "\n", "Association")) +
    ISA_theme()
    
  ISA_Heatmap_Annotated <- ggpubr::annotate_figure(p)
  print(ISA_Heatmap_Annotated) 
  caption <- paste(" Fig", fig_counter, ". Indicator Species Analysis (ISA) for sites at", i, ". ISA indicates species significantly associated with nMDS clustering groups. Values shown in heatmap indicate ISA strengths of associations scaled in green if significant, or display as red if insignficant.")
  print(caption)
  fig_counter <- fig_counter + 1
}
```

Table 4. Summary cross reference table for Indicator Species Analysis.
```{r Heat Map Summary and Cross Reference Tables}
heat_table <- heat_map %>%
  tidyr::drop_na() %>%
  dplyr::group_by(ScientificName, Year) %>%
  dplyr::mutate(Distribution = n()) %>%
  dplyr::ungroup() %>%
  dplyr::filter(Distribution == 1) %>%
  dplyr::distinct(ScientificName, IslandName, Year) %>%
  dplyr::select(ScientificName, IslandName, Year) %>%
  tidyr::pivot_wider(names_from = IslandName, values_from = Year, values_fn = list)

sr_perf_indicators <- heat_table %>% 
  dplyr::select(ScientificName, `Santa Rosa Island`) %>% 
  dplyr::filter(!purrr::map_lgl(`Santa Rosa Island`, is.null))

sc_perf_indicators <- heat_table %>% 
  dplyr::select(ScientificName, `Santa Cruz Island`) %>% 
  dplyr::filter(!purrr::map_lgl(`Santa Cruz Island`, is.null))

an_perf_indicators <- heat_table %>% 
  dplyr::select(ScientificName, `Anacapa Island`) %>% 
  dplyr::filter(!purrr::map_lgl(`Anacapa Island`, is.null))

sb_perf_indicators <- heat_table %>% 
  dplyr::select(ScientificName, `Santa Barbara Island`) %>% 
  dplyr::filter(!purrr::map_lgl(`Santa Barbara Island`, is.null))

heat_table_summary <- heat_map %>% # USE ME
  tidyr::drop_na() %>% 
  dplyr::group_by(ScientificName, Year) %>%
  dplyr::mutate(Distribution = n(),
                Years = "Years") %>%
  dplyr::ungroup() %>%
  dplyr::filter(Distribution > 1) %>%
  dplyr::distinct(ScientificName, Year, Years) %>%
  dplyr::select(ScientificName, Year, Years) %>%
  dplyr::arrange(ScientificName, Year, Years)  %>%
  tidyr::pivot_wider(names_from = Years, values_from = Year, values_fn = list)

# knitr::kable(heat_table,
#              caption= "Full cross reference table for species indicator analysis")
# knitr::kable(sr_perf_indicators,
#              caption= "Perfect Indicator species table for Santa Rosa Island")
# knitr::kable(sc_perf_indicators,
#              caption= "Perfect Indicator species table for Santa Cruz Island")
# knitr::kable(an_perf_indicators,
#              caption= "Perfect Indicator species table for Anacapa Island")
# knitr::kable(sb_perf_indicators,
#              caption= "Perfect Indicator species table for Santa Barbara Island")
knitr::kable(heat_table_summary)
```

## Species-Specific Biomass, Density, and Percent Cover analyses
### Kelp Biomass

Our generalized linear mixed model indicated significant effects on Macrocystis pyrifera foliar standing crop (biomass) of MPA status (P=`r fsc_MPA_p_val`), Island (P=`r fsc_Isl_p_val`), and their interaction (P=`r fsc_MPA_Isl_p_val`), but not ONI (P=`r fsc_ONI_p_val`; Table 4). Further, M. pyrifera biomass displayed distinct trends over time, as biomass has significantly increased inside MPA protection since 2014 (Fig 10 top), and significantly decreased at Santa Rosa Island while simultaneously increasing at Santa Cruz, Anacapa, and Santa Barbara Islands, converging during the El Nino event in 2014-2015 (Fig 10 middle), despite ONI not being significant in our model. 

Table 4. GLMM Results
```{r Kelp Biomass Summary Tables (GLMM), results = 'asis'}
knitr::kable(fsc, caption= "Model Formula: Foliar Standing Crop = Reserve Status * Island + ONI + (1 | Survey Year)")
```

```{r Kelp Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}

p7 <- ggplot2::ggplot(Benthic_Biomass_Wide, aes(x = Date, y = Macrocystis_pyrifera, linetype= ReserveStatus)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2) +
  ggplot2::geom_smooth(se = FALSE, aes(color = ReserveStatus)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                linetype = "Reserve Status",
                color = "Reserve Status") +
  timeseries_top_theme()

p8 <- ggplot2::ggplot(Benthic_Biomass_Wide, aes(x = Date, y = Macrocystis_pyrifera, color = IslandName)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2, linetype=0) +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                color = "Island") +
  timeseries_top_theme()

p9 <- ggplot2::ggplot() +
  geom_rect(data = SST_Anomaly_Index, aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = 0, fill = ONI_ANOM)) +
  scale_fill_gradient2(high = "darkred", mid = "white", low = "navyblue", midpoint = 0,
                       guide = guide_colorbar(direction = "horizontal", title.position = "top",
                                              order = 3, barheight = unit(.2, "cm"))) +
  ggplot2::geom_smooth(data = Benthic_Biomass_Wide, aes(x = Date, y = Macrocystis_pyrifera, color = IslandName, 
                                                     linetype = ReserveStatus), se=FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(.1, 0))) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  geom_hline(aes(yintercept=0)) +
  ggplot2::guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2, override.aes = list(col = 'black'))) +
  ggplot2::labs(x = "Survey Year", y = NULL,
                color = "Island",
                fill = "Oceanic Nino Index",
                linetype = "Reserve Status") +
  timeseries_bottom_theme()
Kelp_Biomass_Plot <- ggarrange(p7, p8, p9, ncol = 1, align = "v")
Kelp_Biomass_annotated <- ggpubr::annotate_figure(
  Kelp_Biomass_Plot,
  # bottom = text_grob(paste(" Fig 10. Macrocystis pyrifera foliar standing crop (FSC) by reserve status across all reference sites (Top),",
  #                          "\n",
  #                          "FSC by island across all reference sites (Middle), and FSC by island and reserve status across all ",
  #                          "\n",
  #                          "reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing.",
  #                          "\n",
  #                          "Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C."),
  #                    color = "black", size = 12, hjust = 0, x = 0),
  left = text_grob("Foliar Standing Crop (FSC) (g/m²)", color = "black", rot = 90, size = 12)
)
print(Kelp_Biomass_annotated)

``` 
Fig 12. Macrocystis pyrifera foliar standing crop (FSC) by reserve status across all reference sites (Top), FSC by island across all reference sites (Middle), and FSC by island and reserve status across all reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing. Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C.

### Purple Urchin Biomass

Our generalized linear mixed model indicated significant effects on Strongylocentrotus purpuratus biomass of of MPA status (P=`r strpur_MPA_p_val`), Island (P=`r strpur_Isl_p_val`), and their interaction (P=`r strpur_MPA_Isl_p_val`), but not ONI (P=`r strpur_ONI_p_val`; Table 5). S. purpuratus biomass also displayed distinct trends over time, opposite to those we observed for M. pyrifera: S. purpuratus as biomass has significantly decreased inside MPA protection since 2013, but remained relatively consistent outside MPAs (Fig 11 top), and significantly increased at Santa Rosa Island while simultaneously decreasing at Santa Cruz, Anacapa, and Santa Barbara Islands, converging just prior to El Nino event in 2014-2015 (Fig 11 middle), despite ONI not being significant in our model. 

Table 5. GLMM Results
```{r Purple Urchin Biomass Summary Tables (GLMM), results = 'asis'}
knitr::kable(strpur, caption= "Model Formula: Purple Urchin Biomass = Reserve Status * Island + ONI + (1 | Survey Year)")
```

```{r Purple Urchin Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}

p10 <- ggplot2::ggplot(Benthic_Biomass_Wide, aes(x = Date, y = Strongylocentrotus_purpuratus, linetype= ReserveStatus)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2) +
  ggplot2::geom_smooth(se = FALSE, aes(color = ReserveStatus)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                linetype = "Reserve Status",
                color = "Reserve Status") +
  timeseries_top_theme()

p11 <- ggplot2::ggplot(Benthic_Biomass_Wide, aes(x = Date, y = Strongylocentrotus_purpuratus, color = IslandName)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2, linetype=0) +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                color = "Island") +
  timeseries_top_theme()

p12 <- ggplot2::ggplot() +
  geom_rect(data = SST_Anomaly_Index, aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = 0, fill = ONI_ANOM)) +
  scale_fill_gradient2(high = "darkred", mid = "white", low = "navyblue", midpoint = 0,
                       guide = guide_colorbar(direction = "horizontal", title.position = "top",
                                              order = 3, barheight = unit(.2, "cm"))) +
  ggplot2::geom_smooth(data = Benthic_Biomass_Wide, aes(x = Date, y = Strongylocentrotus_purpuratus, color = IslandName, 
                                                     linetype = ReserveStatus), se=FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(.1, 0))) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  geom_hline(aes(yintercept=0)) +
  
  ggplot2::guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2, override.aes = list(col = 'black'))) +
  ggplot2::labs(x = "Survey Year", y = NULL,
                color = "Island",
                fill = "Oceanic Nino Index",
                linetype = "Reserve Status") +
  timeseries_bottom_theme()
PurpleUrchin_Biomass_Plot <- ggarrange(p10, p11, p12, ncol = 1, align = "v")
PurpleUrchin_Biomass_annotated <- ggpubr::annotate_figure(
  PurpleUrchin_Biomass_Plot,
  # bottom = text_grob(paste(" Strongylocentrotus purpuratus (purple urchin) biomass by reserve status across all reference sites",
  #                          "\n",
  #                          "(Top), by island across all reference sites (Middle), and  by island and reserve status across",
  #                          "\n",
  #                          "all reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing.",
  #                          "\n",
  #                          "Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C."),
  #                    color = "black", size = 12, hjust = 0, x = 0),
  left = text_grob(glue("Strongylocentrotus purpuratus", "Biomass (g/m²)"), color = "black", rot = 90, size = 12) #figure out how to make this italic
)
print(PurpleUrchin_Biomass_annotated)

``` 
Fig 13. Strongylocentrotus purpuratus (purple urchin) biomass by reserve status across all reference sites (Top), by island across all reference sites (Middle), and by island and reserve status across all reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing. Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C.

### Red Urchin Biomass

Our generalized linear mixed model indicated significant effects on Mesocentrotus franciscanus biomass of of MPA status (P=`r mesfra_MPA_p_val`), Island (P=`r mesfra_Isl_p_val`), and their interaction (P=`r mesfra_MPA_Isl_p_val`), but not ONI (P=`r mesfra_ONI_p_val`; Table 6). However, the trends over time for MPA protection status and Island were opposite from those observed for S. purpuratus. M. franciscanus biomass has significantly decreased inside MPA protection since 2013, but less so outside MPAs (Fig 12 top), and significantly increased at Santa Rosa Island before declining recently, while simultaneously decreasing at Santa Cruz, Anacapa, and Santa Barbara Islands (Fig 12 middle). While ONI was not significant in our model, the onset of biomass decline at Santa Rosa Island was concurrent with the 2013-15 El Nino event. 

Table 6. GLMM Results
```{r Red Urchin Biomass Summary Tables (GLMM), results = 'asis'}
knitr::kable(mesfra, caption= "Model Formula: Red Urchin Biomass = Reserve Status * Island + ONI + (1 | Survey Year)")
```

```{r Red Urchin Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}

p13 <- ggplot2::ggplot(Benthic_Biomass_Wide, aes(x = Date, y = Strongylocentrotus_franciscanus, linetype= ReserveStatus)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2) +
  ggplot2::geom_smooth(se = FALSE, aes(color = ReserveStatus)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                linetype = "Reserve Status",
                color = "Reserve Status") +
  timeseries_top_theme()

p14 <- ggplot2::ggplot(Benthic_Biomass_Wide, aes(x = Date, y = Strongylocentrotus_franciscanus, color = IslandName)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2, linetype=0) +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                color = "Island") +
  timeseries_top_theme()

p15 <- ggplot2::ggplot() +
  geom_rect(data = SST_Anomaly_Index, aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = 0, fill = ONI_ANOM)) +
  scale_fill_gradient2(high = "darkred", mid = "white", low = "navyblue", midpoint = 0,
                       guide = guide_colorbar(direction = "horizontal", title.position = "top",
                                              order = 3, barheight = unit(.2, "cm"))) +
  ggplot2::geom_smooth(data = Benthic_Biomass_Wide, aes(x = Date, y = Strongylocentrotus_franciscanus, color = IslandName, 
                                                     linetype = ReserveStatus), se=FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(.1, 0))) +
  ggplot2::scale_colour_manual(values = Island_Colors) +  
  geom_hline(aes(yintercept=0)) +
  ggplot2::guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2, override.aes = list(col = 'black'))) +
  ggplot2::labs(x = "Survey Year", y = NULL,
                color = "Island",
                fill = "Oceanic Nino Index",
                linetype = "Reserve Status") +
  timeseries_bottom_theme()
RedUrchin_Biomass_Plot <- ggarrange(p13, p14, p15, ncol = 1, align = "v")
RedUrchin_Biomass_annotated <- ggpubr::annotate_figure(
  RedUrchin_Biomass_Plot,
  # bottom = text_grob(paste(" Fig 12. Strongylocentrotus franciscanus (red urchin) biomass by reserve status across all reference sites (Top),",
  #                          "\n",
  #                          "biomass by island across all reference sites (Middle), and FSC by island and reserve status across",
  #                          "\n",
  #                          "all reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing.",
  #                          "\n",
  #                          "Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C."),
  #                    color = "black", size = 12, hjust = 0, x = 0),
  left = text_grob("Strongylocentrotus franciscanus (g/m²)", color = "black", rot = 90, size = 12)
)
print(RedUrchin_Biomass_annotated)

``` 
Fig 14. Strongylocentrotus franciscanus (red urchin) biomass by reserve status across all reference sites (Top), biomass by island across all reference sites (Middle), and FSC by island and reserve status acrossall reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing. Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C.

### Pycnopodia helianthoides Biomass

Our generalized linear mixed model indicated significant effects on Pycnopodia helianthoides biomass of MPA status (P=`r pychel_MPA_p_val`), Island (P=`r pychel_Isl_p_val`), their interaction (P=`r pychel_MPA_Isl_p_val`), and ONI (P=`r pychel_ONI_p_val`; Table 7). P. helianthoides biomass has completely collapsed since 2013, concurrent with the onset of the 2014-15 El Nino event, but prior to 2013 biomass was significantly higher outside MPAs (Fig 13 top), but also declined more significantly outside MPAs than inside MPAs. Prior to 2013, P helianthoides biomass was also significantly higher at Santa Rosa Island (Fig 13 middle). Lastly, this pattern is opposite of that observed for S. purpuratus.

Table 7. GLMM Results
```{r Pycnopodia helianthoides Biomass Summary Tables (GLMM), results = 'asis'}
knitr::kable(pychel, caption= "Model Formula: Sunflower star Biomass = Reserve Status * Island + ONI + (1 | Survey Year)")
```

```{r Pycnopodia helianthoides Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}

p19 <- ggplot2::ggplot(Benthic_Biomass_Wide, aes(x = Date, y = Pycnopodia_helianthoides, linetype= ReserveStatus)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2) +
  ggplot2::geom_smooth(se = FALSE, aes(color = ReserveStatus)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                linetype = "Reserve Status",
                color = "Reserve Status") +
  timeseries_top_theme()

p20 <- ggplot2::ggplot(Benthic_Biomass_Wide, aes(x = Date, y = Pycnopodia_helianthoides, color = IslandName)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2, linetype=0) +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                color = "Island") +
  timeseries_top_theme()

p21 <- ggplot2::ggplot() +
  geom_rect(data = SST_Anomaly_Index, aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = 0, fill = ONI_ANOM)) +
  scale_fill_gradient2(high = "darkred", mid = "white", low = "navyblue", midpoint = 0,
                       guide = guide_colorbar(direction = "horizontal", title.position = "top",
                                              order = 3, barheight = unit(.2, "cm"))) +
  ggplot2::geom_smooth(data = Benthic_Biomass_Wide, aes(x = Date, y = Pycnopodia_helianthoides, color = IslandName, 
                                                     linetype = ReserveStatus), se=FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(.1, 0))) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  geom_hline(aes(yintercept=0)) +
  ggplot2::guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2, override.aes = list(col = 'black'))) +
  ggplot2::labs(x = "Survey Year", y = NULL,
                color = "Island",
                fill = "Oceanic Nino Index",
                linetype = "Reserve Status") +
  timeseries_bottom_theme()
Pychel_Biomass_Plot <- ggarrange(p19, p20, p21, ncol = 1, align = "v")
Pychel_Biomass_annotated <- ggpubr::annotate_figure(
  Pychel_Biomass_Plot,
  # bottom = text_grob(paste(" Fig 13. Pycnopodia helianthoides (sunflower star) biomass by reserve status across all reference sites",
  #                          "\n",
  #                          "(Top), biomass by island across all reference sites (Middle), and biomass by island and reserve",
  #                          "\n",
  #                          "status across all reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS",
  #                          "\n",
  #                          "smoothing. Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C."),
  #                    color = "black", size = 12, hjust = 0, x = 0),
  left = text_grob(paste("Pycnopodia helianthoides Biomass (g/m²)"), color = "black", rot = 90, size = 12)
)
print(Pychel_Biomass_annotated)

``` 
Fig 15. Pycnopodia helianthoides (sunflower star) biomass by reserve status across all reference sites (Top), biomass by island across all reference sites (Middle), and biomass by island and reserve status across all reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing. Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C.

## Pisaster giganteus Biomass

Our generalized linear mixed model indicated significant effects of MPA status (P=`r pisgig_MPA_p_val`), Island (P=`r pychel_Isl_p_val`), their interaction (P=`r pisgig_MPA_Isl_p_val`), and ONI (P=`r pisgig_ONI_p_val`; Table 8). Similar to other sea star species, Pisaster giganteus populations, which were previously largest outside MPAs (Fig 16 top) and at Santa Cruz Island (Fig 16 middle), crashed to minimal or absent populations during the 2013-2015 El Nino event.

Table 8. GLMM Results
```{r Pisaster giganteus Biomass Summary Tables (GLMM), results = 'asis'}
knitr::kable(pisgig, caption= "Model Formula: Red Urchin Biomass = Reserve Status * Island + ONI + (1 | Survey Year)")
```

```{r Pisaster giganteus Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}

p16 <- ggplot2::ggplot(Benthic_Biomass_Wide, aes(x = Date, y = Pisaster_giganteus, linetype= ReserveStatus)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2) +
  ggplot2::geom_smooth(se = FALSE, aes(color = ReserveStatus)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                linetype = "Reserve Status",
                color = "Reserve Status") +
  timeseries_top_theme()

p17 <- ggplot2::ggplot(Benthic_Biomass_Wide, aes(x = Date, y = Pisaster_giganteus, color = IslandName)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2, linetype=0) +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                color = "Island") +
  timeseries_top_theme()

p18 <- ggplot2::ggplot() +
  geom_rect(data = SST_Anomaly_Index, aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = 0, fill = ONI_ANOM)) +
  scale_fill_gradient2(high = "darkred", mid = "white", low = "navyblue", midpoint = 0,
                       guide = guide_colorbar(direction = "horizontal", title.position = "top",
                                              order = 3, barheight = unit(.2, "cm"))) +
  ggplot2::geom_smooth(data = Benthic_Biomass_Wide, aes(x = Date, y = Pisaster_giganteus, color = IslandName, 
                                                     linetype = ReserveStatus), se=FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(.1, 0))) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  geom_hline(aes(yintercept=0)) +
  ggplot2::guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2, override.aes = list(col = 'black'))) +
  ggplot2::labs(x = "Survey Year", y = NULL,
                color = "Island",
                fill = "Oceanic Nino Index",
                linetype = "Reserve Status") +
  timeseries_bottom_theme()
Pisgig_Biomass_Plot <- ggarrange(p16, p17, p18, ncol = 1, align = "v")
Pisgig_Biomass_annotated <- ggpubr::annotate_figure(
  Pisgig_Biomass_Plot,
  # bottom = text_grob(paste(" Pisaster giganteus (giant-spined star) biomass by reserve status across all reference sites (Top),",
  #                          "\n",
  #                          "biomass by island across all reference sites (Middle), and biomass by island and reserve status across",
  #                          "\n",
  #                          "all reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing.",
  #                          "\n",
  #                          "Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C."),
  #                    color = "black", size = 12, hjust = 0, x = 0),
  left = text_grob(paste("Pisaster giganteus Biomass (g/m²)"), color = "black", rot = 90, size = 12)
)
print(Pisgig_Biomass_annotated)

``` 
Fig 16. Pisaster giganteus (giant-spined star) biomass by reserve status across all reference sites (Top), biomass by island across all reference sites (Middle), and biomass by island and reserve status across all reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing. Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C.

### Patiria miniata Biomass

Our generalized linear mixed model indicated significant effects of MPA status (P=`r patmin_MPA_p_val`), Island (P=`r patmin_Isl_p_val`), their interaction (P=`r patmin_MPA_Isl_p_val`), and ONI (P=`r patmin_ONI_p_val`; Table 9). Patiria miniata populations were highest outside of MPAs (Fig 17 top), and at Santa Rosa Island (Fig 17 middle). However, unlike other sea star species, Patiria miniata populations declined to absence only at warmer water islands (Santa Cruz, Anacapa, Santa Barbara), and this occured following, rather than concurrently with, the 2013-15 El Nino event, and populations declined but stayed present throughout at Santa Rosa Island regardless of reserve status (Fig 17 bottom).

Table 9. GLMM Results
```{r Patiria miniata Biomass Summary Tables (GLMM), results = 'asis'}
knitr::kable(patmin, caption= "Model Formula: Bat star Biomass = Reserve Status * Island + ONI + (1 | Survey Year)")
```

```{r Patiria miniata Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}

p22 <- ggplot2::ggplot(Benthic_Biomass_Wide, aes(x = Date, y = Patiria_miniata, linetype= ReserveStatus)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2) +
  ggplot2::geom_smooth(se = FALSE, aes(color = ReserveStatus)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                linetype = "Reserve Status",
                color = "Reserve Status") +
  timeseries_top_theme()

p23 <- ggplot2::ggplot(Benthic_Biomass_Wide, aes(x = Date, y = Patiria_miniata, color = IslandName)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2, linetype=0) +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                color = "Island") +
  timeseries_top_theme()

p24 <- ggplot2::ggplot() +
  geom_rect(data = SST_Anomaly_Index, aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = 0, fill = ONI_ANOM)) +
  scale_fill_gradient2(high = "darkred", mid = "white", low = "navyblue", midpoint = 0,
                       guide = guide_colorbar(direction = "horizontal", title.position = "top",
                                              order = 3, barheight = unit(.2, "cm"))) +
  ggplot2::geom_smooth(data = Benthic_Biomass_Wide, aes(x = Date, y = Patiria_miniata, color = IslandName, 
                                                     linetype = ReserveStatus), se=FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(.1, 0))) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  geom_hline(aes(yintercept=0)) +
  ggplot2::guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2, override.aes = list(col = 'black'))) +
  ggplot2::labs(x = "Survey Year", y = NULL,
                color = "Island",
                fill = "Oceanic Nino Index",
                linetype = "Reserve Status") +
  timeseries_bottom_theme()
Patmin_Biomass_Plot <- ggarrange(p22, p23, p24, ncol = 1, align = "v")
Patmin_Biomass_annotated <- ggpubr::annotate_figure(
  Patmin_Biomass_Plot,
  bottom = text_grob(paste(" Patiria miniata (bat star) biomass by reserve status across all reference sites (Top), biomass",
                           "\n",
                           "by island across all reference sites (Middle), and biomass by island and reserve status across all",
                           "\n",
                           "reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing.",
                           "\n",
                           "Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C."),
                     color = "black", size = 12, hjust = 0, x = 0),
  left = text_grob(paste("Patiria miniata Biomass (g/m²)"), color = "black", rot = 90, size = 12)
)
print(Patmin_Biomass_annotated)

``` 
Fig 17. Patiria miniata (bat star) biomass by reserve status across all reference sites (Top), biomass by island across all reference sites (Middle), and biomass by island and reserve status across all reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing. Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C.

### Haliotis rufescens Biomass

Our generalized linear mixed model indicated significant effects of MPA status (P=`r halruf_MPA_p_val`), Island (P=`r halruf_Isl_p_val`), and their interaction (P=`r halruf_MPA_Isl_p_val`), but not ONI (Table 10). In the MPA reference dataset, Haliotis rufescens only occured at Santa Rosa Island (however, they are also present at San Miguel Island), and populations were larger inside MPAs (Fig 18 bottom). Concurrent with the 2013-15 El Nino event, Haliotis rufescens populations have declined, and a population is maintained inside MPAs at Santa Rosa Island.

Table 10. GLMM Results
```{r Haliotis rufescens Biomass Summary Tables (GLMM), results = 'asis'}
knitr::kable(halruf, caption= "Model Formula: Red abalone Biomass = Reserve Status * Island + ONI + (1 | Survey Year)")
```

```{r Haliotis rufescens Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}

p25 <- ggplot2::ggplot(Benthic_Biomass_Wide, aes(x = Date, y = Haliotis_rufescens, linetype= ReserveStatus)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2) +
  ggplot2::geom_smooth(se = FALSE, aes(color = ReserveStatus)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                linetype = "Reserve Status",
                color = "Reserve Status") +
  timeseries_top_theme()

p26 <- ggplot2::ggplot(Benthic_Biomass_Wide, aes(x = Date, y = Haliotis_rufescens, color = IslandName)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2, linetype=0) +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                color = "Island") +
  timeseries_top_theme()

p27 <- ggplot2::ggplot() +
  geom_rect(data = SST_Anomaly_Index, aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = 0, fill = ONI_ANOM)) +
  scale_fill_gradient2(high = "darkred", mid = "white", low = "navyblue", midpoint = 0,
                       guide = guide_colorbar(direction = "horizontal", title.position = "top",
                                              order = 3, barheight = unit(.2, "cm"))) +
  ggplot2::geom_smooth(data = Benthic_Biomass_Wide, aes(x = Date, y = Haliotis_rufescens, color = IslandName, 
                                                     linetype = ReserveStatus), se=FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(.1, 0))) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  geom_hline(aes(yintercept=0)) +
  ggplot2::guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2, override.aes = list(col = 'black'))) +
  ggplot2::labs(x = "Survey Year", y = NULL,
                color = "Island",
                fill = "Oceanic Nino Index",
                linetype = "Reserve Status") +
  timeseries_bottom_theme()
Halruf_Biomass_Plot <- ggarrange(p25, p26, p27, ncol = 1, align = "v")
Halruf_Biomass_annotated <- ggpubr::annotate_figure(
  Halruf_Biomass_Plot,
  # bottom = text_grob(paste(" Haliotis rufescens (red abalone) biomass by reserve status across all reference sites (A),",
  #                          "\n",
  #                          "biomass by island across all reference sites (B), and FSC by island and reserve status across",
  #                          "\n",
  #                          "all reference sites (C); grey intervals indicate 95% confidence ranges with LOESS smoothing.",
  #                          "\n",
  #                          "Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C."),
  #                    color = "black", size = 12, hjust = 0, x = 0),
  left = text_grob(paste("Haliotis rufescens Biomass (g/m²)"), color = "black", rot = 90, size = 12)
)
print(Halruf_Biomass_annotated)

``` 
Fig 18. Haliotis rufescens (red abalone) biomass by reserve status across all reference sites (A), biomass by island across all reference sites (B), and FSC by island and reserve status across all reference sites (C); grey intervals indicate 95% confidence ranges with LOESS smoothing. Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C.

### Tethya aurantia Biomass

Our generalized linear mixed model indicated significant effects of Island (P=`r tetaur_Isl_p_val`), the interaction between Island and MPA status (P=`r tetaur_MPA_Isl_p_val`), and ONI (P=`r tetaur_ONI_p_val`), but not MPA status alone (P=`r tetaur_MPA_p_val`; Table 11). Populations were substantially larger at Santa Rosa Island prior to 2013 (Fig 19 middle), but then decline at all islands during and following the 2013-15 El Nino Event.


Table 11. GLMM Results
```{r Tethya aurantia Biomass Summary Tables (GLMM), results = 'asis'}
knitr::kable(tetaur, caption= "Model Formula: Orange Puffball sponge Biomass = Reserve Status * Island + ONI + (1 | Survey Year)")
```

```{r Tethya aurantia Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}

p28 <- ggplot2::ggplot(Benthic_Biomass_Wide, aes(x = Date, y = Tethya_aurantia, linetype= ReserveStatus)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2) +
  ggplot2::geom_smooth(se = FALSE, aes(color = ReserveStatus)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                linetype = "Reserve Status",
                color = "Reserve Status") +
  timeseries_top_theme()

p29 <- ggplot2::ggplot(Benthic_Biomass_Wide, aes(x = Date, y = Tethya_aurantia, color = IslandName)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2, linetype=0) +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                color = "Island") +
  timeseries_top_theme()

p30 <- ggplot2::ggplot() +
  geom_rect(data = SST_Anomaly_Index, aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = 0, fill = ONI_ANOM)) +
  scale_fill_gradient2(high = "darkred", mid = "white", low = "navyblue", midpoint = 0,
                       guide = guide_colorbar(direction = "horizontal", title.position = "top",
                                              order = 3, barheight = unit(.2, "cm"))) +
  ggplot2::geom_smooth(data = Benthic_Biomass_Wide, aes(x = Date, y = Tethya_aurantia, color = IslandName, 
                                                     linetype = ReserveStatus), se=FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(.1, 0))) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  geom_hline(aes(yintercept=0)) +
  ggplot2::guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2, override.aes = list(col = 'black'))) +
  ggplot2::labs(x = "Survey Year", y = NULL,
                color = "Island",
                fill = "Oceanic Nino Index",
                linetype = "Reserve Status") +
  timeseries_bottom_theme()
Tetaur_Biomass_Plot <- ggarrange(p28, p29, p30, ncol = 1, align = "v")
Tetaur_Biomass_annotated <- ggpubr::annotate_figure(
  Tetaur_Biomass_Plot,
  # bottom = text_grob(paste(" Tethya aurantia (orange puffball sponge) biomass by reserve status across all reference sites (A),",
  #                          "\n",
  #                          "biomass by island across all reference sites (B), and FSC by island and reserve status across",
  #                          "\n",
  #                          "all reference sites (C); grey intervals indicate 95% confidence ranges with LOESS smoothing.",
  #                          "\n",
  #                          "Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C."),
  #                    color = "black", size = 12, hjust = 0, x = 0),
  left = text_grob(paste("Tethya aurantia Biomass (g/m²)"), color = "black", rot = 90, size = 12)
)
print(Tetaur_Biomass_annotated)

``` 
Fig 19. Tethya aurantia (orange puffball sponge) biomass by reserve status across all reference sites (A), biomass by island across all reference sites (B), and FSC by island and reserve status across all reference sites (C); grey intervals indicate 95% confidence ranges with LOESS smoothing. Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C.

### Kellet's whelk Biomass
Placeholder since this came up in RF after we made most graph sets

## Hypsypops rubicundis Biomass

Our generalized linear mixed model indicated significant effects of MPA status (P=`r hyprub_MPA_p_val`), Island (P=`r hyprub_Isl_p_val`), but not their interaction or ONI (Table 12). Beginning in 2012, Hypsypops rubicundus have significantly more biomass outside of MPA protection than inside (Fig 20 top), and while populations are stable at Santa Cruz and Santa Barbara Islands, the population at Anacapa Island has grown since 2013 (Fig 20 middle).

Table 12. GLMM Results
```{r Hypsypops rubicundis Biomass Summary Tables (GLMM), results = 'asis'}
knitr::kable(hyprub, caption= "Model Formula: Orange Puffball sponge Biomass = Reserve Status * Island + ONI + (1 | Survey Year)")
```

```{r Hypsypops rubicundis Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}

p31 <- ggplot2::ggplot(Fish_Biomass_Wide, aes(x = Date, y = Hypsypops_rubicundus, linetype= ReserveStatus)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2) +
  ggplot2::geom_smooth(se = FALSE, aes(color = ReserveStatus)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                linetype = "Reserve Status",
                color = "Reserve Status") +
  timeseries_top_theme()

p32 <- ggplot2::ggplot(Fish_Biomass_Wide, aes(x = Date, y = Hypsypops_rubicundus, color = IslandName)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2, linetype=0) +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                color = "Island") +
  timeseries_top_theme()

p33 <- ggplot2::ggplot() +
  geom_rect(data = SST_Anomaly_Index,
            aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = 0, fill = ONI_ANOM)) +
  scale_fill_gradient2(high = "darkred", mid = "white", low = "navyblue", midpoint = 0,
                       guide = guide_colorbar(direction = "horizontal", title.position = "top",
                                              order = 3, barheight = unit(.2, "cm"))) +
  ggplot2::geom_smooth(data = Fish_Biomass_Wide, aes(x = Date, y = Hypsypops_rubicundus, color = IslandName, 
                                                  linetype = ReserveStatus), se=FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(.1, 0))) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  geom_hline(aes(yintercept=0)) +
  ggplot2::guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2, override.aes = list(col = 'black'))) +
  ggplot2::labs(x = "Survey Year", y = NULL,
                color = "Island",
                fill = "Oceanic Nino Index",
                linetype = "Reserve Status") +
  timeseries_bottom_theme()
Hyprub_Biomass_Plot <- ggarrange(p31, p32, p33, ncol = 1, align = "v")
Hyprub_Biomass_annotated <- ggpubr::annotate_figure(
  Hyprub_Biomass_Plot,
  # bottom = text_grob(paste(" Hypsypops rubicundus (Garibaldi) biomass by reserve status across all reference sites (Top),",
  #                          "\n",
  #                          "biomass by island across all reference sites (Middle), and FSC by island and reserve status across",
  #                          "\n",
  #                          "all reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing.",
  #                          "\n",
  #                          "Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C."),
  #                    color = "black", size = 12, hjust = 0, x = 0),
  left = text_grob(paste("Hypsypops rubicundus Biomass (g/site)"), color = "black", rot = 90, size = 12)
)
print(Hyprub_Biomass_annotated)

``` 
Fig 20. Hypsypops rubicundus (Garibaldi) biomass by reserve status across all reference sites (Top), biomass by island across all reference sites (Middle), and FSC by island and reserve status across all reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing. Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C.

### Halichoeres semicinctus Biomass

Our generalized linear mixed model indicated significant effects of Island (P=`r halsem_Isl_p_val`), but not MPA status, the interaction, or ONI (Table 13). Halichoeres simicinctus populations had relatively low biomasses until 2013, when the populations grew drastically at Santa Barbara, Anacapa, and Santa Cruz Islands (Fig 21 middle).

Table 13. GLMM Results
```{r Halichoeres semicinctus Biomass Summary Tables (GLMM), results = 'asis'}
knitr::kable(halsem, caption= "Model Formula: Orange Puffball sponge Biomass = Reserve Status * Island + ONI + (1 | Survey Year)")
```

```{r Halichoeres semicinctus Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}

p34 <- ggplot2::ggplot(Fish_Biomass_Wide, aes(x = Date, y = Halichoeres_semicinctus, linetype= ReserveStatus)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2) +
  ggplot2::geom_smooth(se = FALSE, aes(color = ReserveStatus)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                linetype = "Reserve Status",
                color = "Reserve Status") +
  timeseries_top_theme()

p35 <- ggplot2::ggplot(Fish_Biomass_Wide, aes(x = Date, y = Halichoeres_semicinctus, color = IslandName)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2, linetype=0) +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                color = "Island") +
  timeseries_top_theme()

p36 <- ggplot2::ggplot() +
  geom_rect(data = SST_Anomaly_Index, 
            aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = 0, fill = ONI_ANOM)) +
  scale_fill_gradient2(high = "darkred", mid = "white", low = "navyblue", midpoint = 0,
                       guide = guide_colorbar(direction = "horizontal", title.position = "top",
                                              order = 3, barheight = unit(.2, "cm"))) +
  ggplot2::geom_smooth(data = Fish_Biomass_Wide, aes(x = Date, y = Halichoeres_semicinctus, color = IslandName, 
                                                  linetype = ReserveStatus), se=FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(.1, 0))) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  geom_hline(aes(yintercept=0)) +
  ggplot2::guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2, override.aes = list(col = 'black'))) +
  ggplot2::labs(x = "Survey Year", y = NULL,
                color = "Island",
                fill = "Oceanic Nino Index",
                linetype = "Reserve Status") +
  timeseries_bottom_theme()
Halsem_Biomass_Plot <- ggarrange(p34, p35, p36, ncol = 1, align = "v")
Halsem_Biomass_annotated <- ggpubr::annotate_figure(
  Halsem_Biomass_Plot,
  # bottom = text_grob(paste(" Halichoeres semicinctus (Rock Wrasse) biomass by reserve status across all reference sites (Top),",
  #                          "\n",
  #                          "biomass by island across all reference sites (Middle), and FSC by island and reserve status across",
  #                          "\n",
  #                          "all reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing.",
  #                          "\n",
  #                          "Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C."),
  #                    color = "black", size = 12, hjust = 0, x = 0),
  left = text_grob(paste("Halichoeres semicinctus Biomass (g/site)"), color = "black", rot = 90, size = 12)
)
print(Halsem_Biomass_annotated)

``` 
Fig 21. Halichoeres semicinctus (Rock Wrasse) biomass by reserve status across all reference sites (Top), biomass by island across all reference sites (Middle), and FSC by island and reserve status across all reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing. Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C.

## Semicossyphus pulcher Biomass

Our generalized linear mixed model indicated significant effects of MPA status (P=`r sempul_MPA_p_val`), Island (P=`r sempul_Isl_p_val`), and their interaction (P=`r sempul_MPA_Isl_p_val`), but not ONI (Table 14). Semicossyphus pulcher biomass was significantly higher inside MPAs from 2013-2017 (Fig 22 top), and the population with largest biomass occurs at Santa Rosa Island (Fig 22 middle). While populations at inside-MPA sites are beginning to show signs of declines, the respective populations outside MPAs at each island show recent signs of relative increases (Fig 22 bottom).

Table 14. GLMM Results
```{r Semicossyphus pulcher Biomass Summary Tables (GLMM), results = 'asis'}
knitr::kable(sempul, caption= "Model Formula: Orange Puffball sponge Biomass = Reserve Status * Island + ONI + (1 | Survey Year)")
```

```{r Semicossyphus pulcher Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}

p37 <- ggplot2::ggplot(Fish_Biomass_Wide, aes(x = Date, y = Semicossyphus_pulcher, linetype= ReserveStatus)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2) +
  ggplot2::geom_smooth(se = FALSE, aes(color = ReserveStatus)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                linetype = "Reserve Status",
                color = "Reserve Status") +
  timeseries_top_theme()

p38 <- ggplot2::ggplot(Fish_Biomass_Wide, aes(x = Date, y = Semicossyphus_pulcher, color = IslandName)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2, linetype=0) +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                color = "Island") +
  timeseries_top_theme()

p39 <- ggplot2::ggplot() +
  geom_rect(data = SST_Anomaly_Index, 
            aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = 0, fill = ONI_ANOM)) +
  scale_fill_gradient2(high = "darkred", mid = "white", low = "navyblue", midpoint = 0,
                       guide = guide_colorbar(direction = "horizontal", title.position = "top",
                                              order = 3, barheight = unit(.2, "cm"))) +
  ggplot2::geom_smooth(data = Fish_Biomass_Wide, aes(x = Date, y = Semicossyphus_pulcher, color = IslandName, 
                                                  linetype = ReserveStatus), se=FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(.1, 0))) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  geom_hline(aes(yintercept=0)) +
  ggplot2::guides(color = guide_legend(order = 1),
                  linetype = guide_legend(order = 2, override.aes = list(col = 'black'))) +
  ggplot2::labs(x = "Survey Year", y = NULL,
                color = "Island",
                fill = "Oceanic Nino Index",
                linetype = "Reserve Status") +
  timeseries_bottom_theme()
Sempul_Biomass_Plot <- ggarrange(p37, p38, p39, ncol = 1, align = "v")
Sempul_Biomass_annotated <- ggpubr::annotate_figure(
  Sempul_Biomass_Plot,
  # bottom = text_grob(paste(" Semicossyphus pulcher (Sheephead) biomass by reserve status across all reference sites (Top),",
  #                          "\n",
  #                          "biomass by island across all reference sites (Middle), and FSC by island and reserve status across",
  #                          "\n",
  #                          "all reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing.",
  #                          "\n",
  #                          "Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C."),
  #                    color = "black", size = 12, hjust = 0, x = 0),
  left = text_grob(paste("Semicossyphus pulcher Biomass (g/site²)"), color = "black", rot = 90, size = 12)
)
print(Sempul_Biomass_annotated)

``` 
Fig 22. Semicossyphus pulcher (Sheephead) biomass by reserve status across all reference sites (Top), biomass by island across all reference sites (Middle), and FSC by island and reserve status across all reference sites (Bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing. Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C.

## Kelp Bass Biomass
Placeholder since this, despite not being in RF, is a fishery important enough to talk about (decided after we made most graph sets)

## Panulirus interruptus Density

Our generalized linear mixed model indicated significant effects of MPA status (P=`r palint_MPA_p_val`), Island (P=`r palint_Isl_p_val`), and their interaction (P=`r palint_MPA_Isl_p_val`), but displayed distinct trends over time (Fig 24). Panulirus interruptus populations are significantly larger inside MPAs (Fig 23 top), and at the greatest rate of increase occurred at Anacapa Island, although populations are growing at Santa Cruz and Santa Barbara islands. These population increases between islands are almost exclusively driven by inside-MPA populations at each island (Fig 23 bottom).
Table 15. GLMM Results
```{r Panulirus interruptus Densities Summary Tables (GLMM), results = 'asis'}
knitr::kable(palint, caption= "Model Formula: California spiny lobster density = Reserve Status * Island + ONI + (1 | Survey Year)")
```

```{r Panulirus interruptus Density Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}

p28 <- ggplot2::ggplot(Benthic_Densities_Wide, aes(x = Date, y = Panulirus_interruptus, linetype= ReserveStatus)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2) +
  ggplot2::geom_smooth(se = FALSE, aes(color = ReserveStatus)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                linetype = "Reserve Status",
                color = "Reserve Status") +
  timeseries_top_theme()

p29 <- ggplot2::ggplot(Benthic_Densities_Wide, aes(x = Date, y = Panulirus_interruptus, color = IslandName)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2, linetype=0) +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                color = "Island") +
  timeseries_top_theme()

p30 <- ggplot2::ggplot() +
  geom_rect(data = SST_Anomaly_Index, aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = 0, fill = ONI_ANOM)) +
  scale_fill_gradient2(high = "darkred", mid = "white", low = "navyblue", midpoint = 0,
                       guide = guide_colorbar(direction = "horizontal", title.position = "top",
                                              order = 3, barheight = unit(.2, "cm"))) +
  ggplot2::geom_smooth(data = Benthic_Densities_Wide, aes(x = Date, y = Panulirus_interruptus, color = IslandName, 
                                                     linetype = ReserveStatus), se=FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(.1, 0))) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  geom_hline(aes(yintercept=0)) +
  ggplot2::guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2, override.aes = list(col = 'black'))) +
  ggplot2::labs(x = "Survey Year", y = NULL,
                color = "Island",
                fill = "Oceanic Nino Index",
                linetype = "Reserve Status") +
  timeseries_bottom_theme()
Palint_Density_Plot <- ggarrange(p28, p29, p30, ncol = 1, align = "v")
Palint_Density_annotated <- ggpubr::annotate_figure(
  Palint_Density_Plot,
  # bottom = text_grob(paste(" Panulirus interruptus (California spiny lobster) density by reserve status across all reference sites (A),",
  #                          "\n",
  #                          "by island across all reference sites (B), and by island and reserve status across",
  #                          "\n",
  #                          "all reference sites (C); grey intervals indicate 95% confidence ranges with LOESS smoothing.",
  #                          "\n",
  #                          "Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C."),
  #                    color = "black", size = 12, hjust = 0, x = 0),
  left = text_grob(paste("Panulirus interruptus density (#/m²)"), color = "black", rot = 90, size = 12)
)
print(Palint_Density_annotated)

``` 
Fig 23. Panulirus interruptus (California spiny lobster) density by reserve status across all reference sites (A), by island across all reference sites (B), and by island and reserve status across all reference sites (C); grey intervals indicate 95% confidence ranges with LOESS smoothing. Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C.

Lobster also have a significant fishery... 

```{r loby lob, warning=FALSE, message=FALSE, fig.height=5.5, fig.width=10}
loby <- read_csv(
  glue("Raw_DB_Files_SAVE_HERE/KFM_BandTransect_RawData_1982-{Export_END_Year}.txt"),   
  col_types = cols(CountA = col_number(), CountB = col_number())) %>%
  dplyr::filter(IslandCode != "CL") %>%
  dplyr::left_join(siteInfo1) %>%
  tidyr::separate(SurveyDate, c('Date','Time'),' ') %>%
  dplyr::mutate(Date = as.Date(Date, format='%m/%d/%Y')) %>%
  tidyr::pivot_longer(cols = c(CountA, CountB), values_to = "Count") %>% 
  dplyr::filter(!is.na(Count), !is.na(CommonName)) %>% 
  dplyr::select(SiteNumber, IslandCode, IslandName, SiteCode, SiteName, Species, ScientificName,
                CommonName, SurveyYear, Date, TransectNumber, Count, ReserveStatus, MeanDepth,
                Reference, Old_New_Comp, ReserveYear) %>% 
  dplyr::group_by(SiteNumber, ScientificName, CommonName, SurveyYear, TransectNumber) %>%
  dplyr::mutate(Count = sum(Count, na.rm = TRUE)) %>% 
  dplyr::ungroup() %>%
  dplyr::distinct(SiteNumber, ScientificName, SurveyYear, TransectNumber, Count, .keep_all = TRUE)  %>% 
  dplyr::filter(ScientificName == "Panulirus interruptus",
                Old_New_Comp == TRUE) %>% 
  dplyr::group_by(SiteNumber, IslandCode, IslandName, SiteCode, SiteName,  ScientificName,
                  Species, CommonName, Old_New_Comp, ReserveYear,
                  SurveyYear, Date, ReserveStatus, MeanDepth, Reference) %>%
  dplyr::summarise(Count_To_Reuse = Count,
                   Area_Surveyed = ifelse(SurveyYear %in% 1983:1984, n() * 40, n() *60), 
                   Total_Count = sum(Count),
                   Mean_Density = round(Total_Count / Area_Surveyed, 4), 
                   SD = round(sd(Count), 4),
                   SE = round(SD/sqrt(Area_Surveyed), 4)) %>% 
  dplyr::ungroup() %>%  
  dplyr::select(SiteNumber, IslandCode, IslandName, SiteCode, SiteName, 
                Species, CommonName,
                ScientificName,SurveyYear, 
                Date, Total_Count, Mean_Density, SD, SE, Area_Surveyed,
                ReserveStatus, MeanDepth, Reference, Old_New_Comp, ReserveYear) %>%
  dplyr::distinct(SiteNumber, IslandCode, IslandName, SiteCode, SiteName,
                  Species, CommonName, ScientificName, SurveyYear, 
                  Total_Count, Mean_Density, SD, SE, Area_Surveyed, .keep_all = TRUE)

ggplot(loby, aes(x = SurveyYear, y = Mean_Density, color = ReserveYear, linetype = ReserveYear)) + 
  ggplot2::stat_smooth(geom='ribbon', alpha = .2, linetype = 0, 
                       aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..))) +
  geom_smooth(size = 1, se = FALSE, alpha = 1) +
  geom_vline(aes(xintercept = 2003), size = 1) +
  geom_label(aes(x = 2003, y = Inf, vjust = 1, hjust = 1, label = "New MPAs Created"), color = "black") +
  scale_x_continuous(breaks = c(1982:Year_to_Filter_Data_by), expand = c(0,0)) +
  scale_y_continuous(expand = expansion(mult = c(0, .1))) +
  labs(title = loby$ScientificName,  
       subtitle = loby$CommonName,
       color = "Reserve Year", linetype = "Reserve Year",
       x = "Survey Year", y = "Mean Density (g/m²)") +
  Original_16_theme()
```
Fig 24. A comparison of Panulirus interruptus (California spiny lobster) density from the original 16 survey sites for the entirety of the Kelp Forest Monitoring Program, separated by reserve status. Landing and Cathedral Coves at Anacapa Island have been reserves since 1978, and were expanded along with the implementation of the remaining reserves in 2003. 

## Parastichopus parvimensis Density

usual format over time, and then old reserve/new reserve/dive fishery story in this results section too

Our generalized linear mixed model indicated significant effects of MPA status (P=), Island (P=), and their interaction (P=), but displayed distinct trends over time (Fig 25).

Table 16. GLMM Results
```{r warty cucumber Densities Summary Tables (GLMM), results = 'asis'}
knitr::kable(parpar, caption= "Model Formula: Warty sea cucumber density = Reserve Status * Island + ONI + (1 | Survey Year)")
```

```{r warty cucumber Density Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}

p28 <- ggplot2::ggplot(Benthic_Densities_Wide, aes(x = Date, y = Parastichopus_parvimensis, linetype= ReserveStatus)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2) +
  ggplot2::geom_smooth(se = FALSE, aes(color = ReserveStatus)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                linetype = "Reserve Status",
                color = "Reserve Status") +
  timeseries_top_theme()
 
p29 <- ggplot2::ggplot(Benthic_Densities_Wide, aes(x = Date, y = Parastichopus_parvimensis, color = IslandName)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2, linetype=0) +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                color = "Island") +
  timeseries_top_theme()

p30 <- ggplot2::ggplot() +
  geom_rect(data = SST_Anomaly_Index, aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = 0, fill = ONI_ANOM)) +
  scale_fill_gradient2(high = "darkred", mid = "white", low = "navyblue", midpoint = 0,
                       guide = guide_colorbar(direction = "horizontal", title.position = "top",
                                              order = 3, barheight = unit(.2, "cm"))) +
  ggplot2::geom_smooth(data = Benthic_Densities_Wide, aes(x = Date, y = Parastichopus_parvimensis, color = IslandName, 
                                                     linetype = ReserveStatus), se=FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(.1, 0))) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  geom_hline(aes(yintercept=0)) +
  ggplot2::guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2, override.aes = list(col = 'black'))) +
  ggplot2::labs(x = "Survey Year", y = NULL,
                color = "Island",
                fill = "Oceanic Nino Index",
                linetype = "Reserve Status") +
  timeseries_bottom_theme()
Parpar_Density_Plot <- ggarrange(p28, p29, p30, ncol = 1, align = "v")
Parpar_Density_annotated <- ggpubr::annotate_figure(
  Parpar_Density_Plot,
  # bottom = text_grob(paste(" Parastichopus parvimensis (Warty sea cucumber) density by reserve status across all reference sites (A),",
  #                          "\n",
  #                          "by island across all reference sites (B), and by island and reserve status across",
  #                          "\n",
  #                          "all reference sites (C); grey intervals indicate 95% confidence ranges with LOESS smoothing.",
  #                          "\n",
  #                          "Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C."),
  #                    color = "black", size = 12, hjust = 0, x = 0),
  left = text_grob(paste("Parastichopusparvimensis density (#/m²)"), color = "black", rot = 90, size = 12)
)
print(Parpar_Density_annotated)

``` 
Fig 25. Parastichopus parvimensis (Warty sea cucumber) density by reserve status across all reference sites (A), by island across all reference sites (B), and by island and reserve status across all reference sites (C); grey intervals indicate 95% confidence ranges with LOESS smoothing. Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C.

Warty sea cucumbers also had a fishery - 

```{r Par Par 1, warning=FALSE, message=FALSE, fig.height=5.5, fig.width=10}
parpar <- readr::read_csv(
  glue("Raw_DB_Files_SAVE_HERE/KFM_1mQuadrat_RawData_1982-{Export_END_Year}.txt"),   
  col_types = cols(CountA = col_number(), CountB = col_number())) %>%
  dplyr::filter(IslandCode != "CL") %>%
  dplyr::left_join(siteInfo1) %>%
  tidyr::separate(SurveyDate, c('Date','Time'),' ') %>%
  dplyr::mutate(Date = as.Date(Date, format='%m/%d/%Y')) %>% 
  tidyr::pivot_longer(cols = c(CountA, CountB), values_to = "Count") %>% 
  dplyr::filter(!is.na(Count), !is.na(CommonName)) %>% 
  dplyr::select(SiteNumber, IslandCode, IslandName, SiteCode, SiteName, Species, ScientificName,
                CommonName, SurveyYear, Date, QuadratNumber, Count, ReserveStatus, MeanDepth, 
                Reference, Old_New_Comp, ReserveYear) %>% 
  dplyr::filter(ScientificName == "Parastichopus parvimensis",
                Old_New_Comp == TRUE) %>% 
  dplyr::group_by(SiteNumber, IslandCode, IslandName, SiteCode, SiteName,  ScientificName,
                  Species, CommonName, Old_New_Comp, ReserveYear,
                  SurveyYear, Date, ReserveStatus, MeanDepth, Reference) %>%
  dplyr::summarise(Count_To_Reuse = Count,
                   Area_Surveyed = ifelse(SurveyYear %in% 1985:1994, n() * 2, n()),
                   Total_Count = sum(Count),
                   Mean_Density = round(Total_Count / Area_Surveyed, 4), 
                   SD = round(sd(Count), 4),
                   SE = round(SD / sqrt(Area_Surveyed), 4)) %>% 
  dplyr::ungroup() %>%  
  dplyr::select(SiteNumber, IslandCode, IslandName, SiteCode, SiteName, 
                Species, CommonName,
                ScientificName,SurveyYear, 
                Date, Total_Count, Mean_Density, SD, SE, Area_Surveyed,
                ReserveStatus, MeanDepth, Reference, Old_New_Comp, ReserveYear) %>%
  dplyr::distinct(SiteNumber, IslandCode, IslandName, SiteCode, SiteName,
                  Species, CommonName, ScientificName, SurveyYear, 
                  Total_Count, Mean_Density, SD, SE, Area_Surveyed, .keep_all = TRUE)

ggplot(parpar, aes(x = SurveyYear, y = Mean_Density, color = ReserveYear, linetype = ReserveYear)) + 
  ggplot2::stat_smooth(geom='ribbon', alpha = .2, linetype = 0, 
                       aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..))) +
  geom_smooth(size = 1, se = FALSE, alpha = 1) +
  geom_vline(aes(xintercept = 1993), size = 1) +
  geom_label(aes(x = 1993, y = Inf, vjust = 1, hjust = 1, label = "Dive Fishery Begins"), color = "black") +
  geom_vline(aes(xintercept = 2003), size = 1) +
  geom_label(aes(x = 2003, y = Inf, vjust = 1, hjust = 1, label = "New MPAs Created"), color = "black") +
  scale_x_continuous(breaks = c(1982:Year_to_Filter_Data_by), expand = c(0,0)) +
  scale_y_continuous(expand = expansion(mult = c(0, .1))) +
  labs(title = parpar$ScientificName,  
       subtitle = parpar$CommonName,
       color = "Reserve Year", linetype = "Reserve Year",
       # caption = "Data from 11 of the 16 original KFM sites at Santa Cruz Island, Anacapa Island, and Santa Barbara Island. \nTwo sites make up the 1978 reserve, Cathedral Cove and Landing Cove. \nThree sites make up the 2003 reserve, Gull Island South, Scorpion Anchorage, and Southeast Sea Lion. \nSix sites make up outside the reserves, Fry's Harbor, Pelican Bay, Yellow Banks, Admiral's Reef, Arch Point, and Cat Canyon",
       x = "Survey Year", y = "Mean Density (g/m²)") +
  Original_16_theme()
```
Fig 26. A comparison of Parastichopus parvimensis (Warty sea cucumber) density from the original 16 survey sites for the entirety of the Kelp Forest Monitoring Program, separated by reserve status. Landing and Cathedral Coves at Anacapa Island have been reserves since 1978, and were expanded along with the implementation of the remaining reserves in 2003. Beginning of the dive-based fishery in 1993 is shown.

## Centrostephanus coronatus Density

Our generalized linear mixed model indicated significant effects of MPA status (P=), Island (P=), and their interaction (P=), but displayed distinct trends over time (Fig 17). More text will go here

Table 17. GLMM Results
```{r Centrostephanus_coronatus Densities Summary Tables (GLMM), results = 'asis'}
knitr::kable(cencor, caption= "Model Formula: Coronado urchin density = Reserve Status * Island + ONI + (1 | Survey Year)")
```

```{r Centrostephanus_coronatus Density Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}

p28 <- ggplot2::ggplot(Benthic_Densities_Wide, aes(x = Date, y = Centrostephanus_coronatus, linetype= ReserveStatus)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2) +
  ggplot2::geom_smooth(se = FALSE, aes(color = ReserveStatus)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                linetype = "Reserve Status",
                color = "Reserve Status") +
  timeseries_top_theme()

p29 <- ggplot2::ggplot(Benthic_Densities_Wide, aes(x = Date, y = Centrostephanus_coronatus, color = IslandName)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2, linetype=0) +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                color = "Island") +
  timeseries_top_theme()

p30 <- ggplot2::ggplot() +
  geom_rect(data = SST_Anomaly_Index, aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = 0, fill = ONI_ANOM)) +
  scale_fill_gradient2(high = "darkred", mid = "white", low = "navyblue", midpoint = 0,
                       guide = guide_colorbar(direction = "horizontal", title.position = "top",
                                              order = 3, barheight = unit(.2, "cm"))) +
  ggplot2::geom_smooth(data = Benthic_Densities_Wide, 
                       aes(x = Date, y = Centrostephanus_coronatus, color = IslandName, 
                           linetype = ReserveStatus), se=FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(.1, 0))) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  geom_hline(aes(yintercept=0)) +
  ggplot2::guides(color = guide_legend(order = 1), 
                  linetype = guide_legend(order = 2, override.aes = list(col = 'black'))) +
  ggplot2::labs(x = "Survey Year", y = NULL,
                color = "Island",
                fill = "Oceanic Nino Index",
                linetype = "Reserve Status") +
  timeseries_bottom_theme()
cencor_Density_Plot <- ggarrange(p28, p29, p30, ncol = 1, align = "v")
cencor_Density_annotated <- ggpubr::annotate_figure(
  cencor_Density_Plot,
  # bottom = text_grob(paste(" Centrostephanus coronatus (Coronado urchin) density by reserve status across all reference sites (A),",
  #                          "\n",
  #                          "by island across all reference sites (B), and by island and reserve status across",
  #                          "\n",
  #                          "all reference sites (C); grey intervals indicate 95% confidence ranges with LOESS smoothing.",
  #                          "\n",
  #                          "Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C."),
  #                    color = "black", size = 12, hjust = 0, x = 0),
  left = text_grob(paste("Centrostephanus coronatus density (#/m²)"), color = "black", rot = 90, size = 12)
)
print(cencor_Density_annotated)

``` 
Fig 27. Centrostephanus coronatus (Coronado urchin) density by reserve status across all reference sites (A), by island across all reference sites (B), and by island and reserve status across all reference sites (C); grey intervals indicate 95% confidence ranges with LOESS smoothing. Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C.

## Lophogorgia chilensis Density

Our generalized linear mixed model indicated significant effects of MPA status (P=), Island (P=), and their interaction (P=), but displayed distinct trends over time (Fig 28). More text will go here

Table 18. GLMM Results
```{r Lophogorgia chilensis Densities Summary Tables (GLMM), results = 'asis'}
knitr::kable(lopchi, caption= "Model Formula: Red Gorgonian = Reserve Status * Island + ONI + (1 | Survey Year)")
```

```{r Lophogorgia chilensis Density Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}

p28 <- ggplot2::ggplot(Benthic_Densities_Wide, aes(x = Date, y = Lophogorgia_chilensis, linetype= ReserveStatus)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2) +
  ggplot2::geom_smooth(se = FALSE, aes(color = ReserveStatus)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                linetype = "Reserve Status",
                color = "Reserve Status") +
  timeseries_top_theme()

p29 <- ggplot2::ggplot(Benthic_Densities_Wide, aes(x = Date, y = Lophogorgia_chilensis, color = IslandName)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2, linetype=0) +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                color = "Island") +
  timeseries_top_theme()

p30 <- ggplot2::ggplot() +
  geom_rect(data = SST_Anomaly_Index, aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = 0, fill = ONI_ANOM)) +
  scale_fill_gradient2(high = "darkred", mid = "white", low = "navyblue", midpoint = 0,
                       guide = guide_colorbar(direction = "horizontal", title.position = "top",
                                              order = 3, barheight = unit(.2, "cm"))) +
  ggplot2::geom_smooth(data = Benthic_Densities_Wide, aes(x = Date, y = Lophogorgia_chilensis, color = IslandName, 
                                                     linetype = ReserveStatus), se=FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(.1, 0))) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  geom_hline(aes(yintercept=0)) +
  ggplot2::guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2, override.aes = list(col = 'black'))) +
  ggplot2::labs(x = "Survey Year", y = NULL,
                color = "Island",
                fill = "Oceanic Nino Index",
                linetype = "Reserve Status") +
  timeseries_bottom_theme()
lopchi_Density_Plot <- ggarrange(p28, p29, p30, ncol = 1, align = "v")
lopchi_Density_annotated <- ggpubr::annotate_figure(
  lopchi_Density_Plot,
  # bottom = text_grob(paste(" Lophogorgia chilensis (Red gorogonian) density by reserve status across all reference sites (A),",
  #                          "\n",
  #                          "by island across all reference sites (B), and by island and reserve status across",
  #                          "\n",
  #                          "all reference sites (C); grey intervals indicate 95% confidence ranges with LOESS smoothing.",
  #                          "\n",
  #                          "Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C."),
  #                    color = "black", size = 12, hjust = 0, x = 0),
  left = text_grob(paste("Lophogorgia chilensis density (#/m²)"), color = "black", rot = 90, size = 12)
)
print(lopchi_Density_annotated)

``` 
Fig 28. Lophogorgia chilensis (Red gorogonian) density by reserve status across all reference sites (A), by island across all reference sites (B), and by island and reserve status across all reference sites (C); grey intervals indicate 95% confidence ranges with LOESS smoothing. Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C.

## Percent Cover
### Cystoseira osmundacea Cover

Our generalized linear mixed model indicated significant effects of MPA status (P=`r cysto_MPA_p_val`), Island (P=`r cysto_Isl_p_val`), and their interaction (P=`r cysto_MPA_Isl_p_val`), but not ONI (Table 19). Populations were significantly larger inside MPAs (Fig 29 top), and while populations at Anacapa, Santa Cruz, and Santa Rosa Islands have been stable, Santa Barbara Island has experienced significant increases in cystoseira cover since 2013 (Fig 29 middle).

Table 19. GLMM Results
```{r Cystoseira cover Summary Tables (GLMM), results = 'asis'}
knitr::kable(cystoseira, caption= "Model Formula: Cystoseira = Reserve Status * Island + ONI + (1 | Survey Year)")
```

```{r Cystoseira cover Plots, warning=FALSE, message=FALSE, fig.width=7.5, fig.height=10}

p28 <- ggplot2::ggplot(RPC_Cover_Wide, aes(x = Date, y = Cystoseira, linetype= ReserveStatus)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2) +
  ggplot2::geom_smooth(se = FALSE, aes(color = ReserveStatus)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                linetype = "Reserve Status",
                color = "Reserve Status") +
  timeseries_top_theme()

p29 <- ggplot2::ggplot(RPC_Cover_Wide, aes(x = Date, y = Cystoseira, color = IslandName)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2, linetype=0) +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                color = "Island") +
  timeseries_top_theme()

p30 <- ggplot2::ggplot() +
  geom_rect(data = SST_Anomaly_Index, aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = 0, fill = ONI_ANOM)) +
  scale_fill_gradient2(high = "darkred", mid = "white", low = "navyblue", midpoint = 0,
                       guide = guide_colorbar(direction = "horizontal", title.position = "top",
                                              order = 3, barheight = unit(.2, "cm"))) +
  ggplot2::geom_smooth(data = RPC_Cover_Wide, aes(x = Date, y = Cystoseira, color = IslandName, 
                                                     linetype = ReserveStatus), se=FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(.1, 0))) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  geom_hline(aes(yintercept=0)) +
  ggplot2::guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2, override.aes = list(col = 'black'))) +
  ggplot2::labs(x = "Survey Year", y = NULL,
                color = "Island",
                fill = "Oceanic Nino Index",
                linetype = "Reserve Status") +
  timeseries_bottom_theme()
cysto_cover_Plot <- ggarrange(p28, p29, p30, ncol = 1, align = "v")
cysto_cover_annotated <- ggpubr::annotate_figure(
  cysto_cover_Plot,
  # bottom = text_grob(paste(" Lophogorgia chilensis (Red gorogonian) density by reserve status across all reference sites (A),",
  #                          "\n",
  #                          "by island across all reference sites (B), and by island and reserve status across",
  #                          "\n",
  #                          "all reference sites (C); grey intervals indicate 95% confidence ranges with LOESS smoothing.",
  #                          "\n",
  #                          "Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C."),
  #                    color = "black", size = 12, hjust = 0, x = 0),
  left = text_grob(paste("Cystoseria osmundacea percent cover"), color = "black", rot = 90, size = 12)
)
print(cysto_cover_annotated)

``` 
Fig 29. Cystoseira osmundacea (bladderchain kelp) density by reserve status across all reference sites (top), by island across all reference sites (middle), and by island and reserve status across all reference sites (bottom); grey intervals indicate 95% confidence ranges with LOESS smoothing. Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C.

### Articulated coralline algae Cover
Our generalized linear mixed model indicated significant effects of MPA status (P=`r artic_MPA_p_val`), Island (P=`r artic_Isl_p_val`), and their interaction (P=`r artic_MPA_Isl_p_val`), but not ONI (Table 19). Populations were significantly larger inside MPAs (Fig 29 top), and while populations at Anacapa, Santa Cruz, and Santa Rosa Islands have been stable, Santa Barbara Island has experienced significant increases in cystoseira cover since 2013 (Fig 29 middle).

```{r artic cover Summary Tables (GLMM), results = 'asis'}
knitr::kable(artic, caption= "Model Formula: articulated coralline algae = Reserve Status * Island + ONI + (1 | Survey Year)")
```

```{r artic cover Plots, warning=FALSE, message=FALSE, fig.width=7.5, fig.height=10}

p28 <- ggplot2::ggplot(RPC_Cover_Wide, aes(x = Date, y = articulated_coralline_algae, linetype= ReserveStatus)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2) +
  ggplot2::geom_smooth(se = FALSE, aes(color = ReserveStatus)) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                linetype = "Reserve Status",
                color = "Reserve Status") +
  timeseries_top_theme()

p29 <- ggplot2::ggplot(RPC_Cover_Wide, aes(x = Date, y = articulated_coralline_algae, color = IslandName)) +
  ggplot2::stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. <0, 0, ..ymin..)), alpha = .2, linetype=0) +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(limits= c(0,NA), expand= c(0,0)) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  ggplot2::labs(x = NULL, y = NULL,
                color = "Island") +
  timeseries_top_theme()

p30 <- ggplot2::ggplot() +
  geom_rect(data = SST_Anomaly_Index, aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = 0, fill = ONI_ANOM)) +
  scale_fill_gradient2(high = "darkred", mid = "white", low = "navyblue", midpoint = 0,
                       guide = guide_colorbar(direction = "horizontal", title.position = "top",
                                              order = 3, barheight = unit(.2, "cm"))) +
  ggplot2::geom_smooth(data = RPC_Cover_Wide, aes(x = Date, y = articulated_coralline_algae, color = IslandName, 
                                                     linetype = ReserveStatus), se=FALSE) +
  ggplot2::scale_x_date(date_labels = "%Y", date_breaks = "year", expand = c(0,0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(.1, 0))) +
  ggplot2::scale_colour_manual(values = Island_Colors) +
  geom_hline(aes(yintercept=0)) +
  ggplot2::guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2, override.aes = list(col = 'black'))) +
  ggplot2::labs(x = "Survey Year", y = NULL,
                color = "Island",
                fill = "Oceanic Nino Index",
                linetype = "Reserve Status") +
  timeseries_bottom_theme()
artic_cover_Plot <- ggarrange(p28, p29, p30, ncol = 1, align = "v")
artic_cover_annotated <- ggpubr::annotate_figure(
  artic_cover_Plot,
  # bottom = text_grob(paste(" Lophogorgia chilensis (Red gorogonian) density by reserve status across all reference sites (A),",
  #                          "\n",
  #                          "by island across all reference sites (B), and by island and reserve status across",
  #                          "\n",
  #                          "all reference sites (C); grey intervals indicate 95% confidence ranges with LOESS smoothing.",
  #                          "\n",
  #                          "Oceanic Nino Index (ONI) is a measure of El Nino oscillation and strength, in units of *C."),
  #                    color = "black", size = 12, hjust = 0, x = 0),
  left = text_grob(paste("articulated coralline algae percent cover"), color = "black", rot = 90, size = 12)
)
print(artic_cover_annotated)
```

## Benthic Biomass Summary

```{r Benthic Biomass Summary, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=11}

ggplot2::ggplot(Benthic_Biomass_Long, aes(x = SurveyYear, y = Mean_Biomass, fill = ScientificName)) +
  ggplot2::geom_area(position = "stack", stat = "smooth") + # <=== Stat can be "identity" too
  ggplot2::scale_x_continuous(breaks = 2005:Year_to_Filter_Data_by) +
  ggplot2::scale_fill_manual(values = BenthicBiomassColor, 
                             guide = guide_legend(ncol = 4, title.hjust = .5, title.position = "top")) +
  ggplot2::facet_grid(rows= vars(IslandName), cols = vars(ReserveStatus), scales = "fixed") +
  ggplot2::labs(title = "Benthic Biomass Summary",
                x = "Survey Year",
                y = "Biomass (g/m²)",
                fill = "Scientific Name") +
  Biomass_Summary_theme()
```

## Fish Biomass Summary

```{r Fish Biomass Summary, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=11}
p1 <- ggplot2::ggplot(Fish_Biomass_Long, 
                      aes(x = SurveyYear, y = Mean_Biomass, fill = CommonName)) +
  ggplot2::geom_area(position = "stack", stat = "smooth") + # <=== Stat can be "identity" too
  ggplot2::scale_x_continuous(breaks = 2005:Year_to_Filter_Data_by) +
  ggplot2::scale_y_continuous(limits = c(0, NA)) +
  ggplot2::scale_fill_manual(values = Fish_Colors,
                             guide = guide_legend(ncol = 6, title.hjust = .5, 
                                                  title.position = "top")) +
  ggplot2::facet_grid(rows= vars(IslandName), cols = vars(ReserveStatus), scales = "free") +
  ggplot2::labs(title = "Fish Biomass Summary", subtitle = "All Species",
                x = "Survey Year", y = "Biomass (g)",
                fill = "Common Name") +
  Biomass_Summary_theme()

p2 <- ggplot2::ggplot(filter(Fish_Biomass_Long, Targeted == "Non-targeted"), 
                      aes(x = SurveyYear, y = Mean_Biomass, fill = CommonName)) +
  ggplot2::geom_area(position = "stack", stat = "smooth") + # <=== Stat can be "identity" too
  ggplot2::scale_x_continuous(breaks = 2005:Year_to_Filter_Data_by) +
  ggplot2::scale_y_continuous(limits = c(0, NA)) +
  ggplot2::scale_fill_manual(values = Fish_Colors,
                             guide = guide_legend(ncol = 6, title.hjust = .5,
                                                  title.position = "top")) +
  ggplot2::facet_grid(rows= vars(IslandName), cols = vars(ReserveStatus), scales = "free") +
  ggplot2::labs(title = "Fish Biomass Summary", subtitle = "Non-targeted",
                x = "Survey Year", y = "Biomass (g)",
                fill = "Common Name") +
  Biomass_Summary_theme()

p3 <- ggplot2::ggplot(filter(Fish_Biomass_Long, Targeted == "Targeted"), 
                      aes(x = SurveyYear, y = Mean_Biomass, fill = CommonName)) +
  ggplot2::geom_area(position = "stack", stat = "smooth") + # <=== Stat can be "identity" too
  ggplot2::scale_x_continuous(breaks = 2005:Year_to_Filter_Data_by) +
  ggplot2::scale_y_continuous(limits = c(0, NA)) +
  ggplot2::scale_fill_manual(values = Fish_Colors,
                             guide = guide_legend(ncol = 6, title.hjust = .5, 
                                                  title.position = "top", position = "bottom")) +
  ggplot2::facet_grid(rows= vars(IslandName), cols = vars(ReserveStatus), scales = "free") +
  ggplot2::labs(title = "Fish Biomass Summary", subtitle = "Targeted",
                x = "Survey Year", y = "Biomass (g)",
                fill = "Common Name") +
  Biomass_Summary_theme()

print(p1)
print(p2)
print(p3)
```

# Discussion

Diversity differences – Recent significant increase inside of MPAs, SR recently decreasing while other islands increasing

Similarity differences - SR distinct 2005-2010, all islands similar 2010-2015, SR distinct again 2016-2019

Biomass trends of species identified in ISA are consistent with other observations in CA kelp forests (kelp deforestation, urchin proliferation, sea star and abalone declines) in the previous decade

Species interactions and biomass/density trends trends…

+    Trend in sea stars and 2013-2014 SSWD 

  + pre blob/El Nino major decline, then blob = perfect storm
  
+ Santa Rosa Island

  +    ISA show Pycnopodia as an indicator inside and outside at Santa Rosa up to 2013

  +    Purple urchins identified by ISA in 2015 inside and 2016 outside and continue to be identified after.

  +    Red urchins identified by ISA in 2015 inside and 2018 outside

  +    Pycnopodia last predator left at Santa Rosa, when they go, there is nothing left to effectively control urchins
  
    + Biomass of sheep head goes up inside and out, with increase in urchins

  +    Main driver for decrease in diversity at SR
  
    + Inside stays more diverse indicating MPA resiliency when confronted with major changes

  +    Urchin biomass increases dramatically as kelp biomass decreases dramitically esp. outside reserve

  +    Red abalone biomass increases initially (increased competition, more foraging) 
  
    + decline later when urchin biomass peaks (out competed)

  +    Kelp no longer identified by ISA outside reserve post 2014, indicates dominance of urchins and impact on kelp
  
  + Tethya have major decline with latest warm water event
    
    + Could be strong correlation with PDO phases (most effected at Santa Rosa)
  
+ Santa Cruz/Anacapa/Santa Barbara

+ Santa Cruz/Anacapa

+ General interactions

  + Garibaldi never indicate inside-MPA communities, only outside, and have significantly higher biomass outside. Perhaps reduced competition due to fishing pressure?
  
  + Halfmoon and opaleye (herbiverous fish) have higher inside/outside biomass ratio where algaes tend to be more plentiful
  
    + reference ratio plot and RPC algal cover plots
    
    Fisheries effects - Lobster and Warty Cucumber - with original 16 plot set showing the effects of old reserves at ANI vs new reserves. I want to use these two examples to draw out points about resiliency, edge effects and "effective MPA size", and larval connectivity
    
   Prior to the new reserve implementation, spiny lobsters exhibited a relatively stable population that was larger inside the old reserves than outside, it’s also worth noting that these old reserves were expanded with the implementation of the new reserves, and following that we see increases across the board (including a small one outside the reserves), but the greatest increase occurs in these oldest MPAs. This is consistent with the notion that edge effects in smaller MPAs are proportionally higher, and leave a proportionally smaller inside area “truly” protected, as well as the notion that the older an MPA is, the higher the resiliency of its community. Lobster are also an important predator of urchins, whose herbivory has major impacts on kelp abundance and biomass. In the coming weeks we’ll show you some more species, including kelp, urchins, and sunflower stars (another important urchin predator), but according to our random forest analysis, spiny lobster are one of the two most important species in identifying whether a community is from inside or outside an MPA.
   
   Warty sea cucumber are  another interesting species for the region, since it had a diving-based fishery begin in the early 1990s, although harvesting began prior to that year. We can see here that the abundance of warty sea cucumbers was relatively even between inside and outside- MPA communities, until the beginning of the fishery, where the outside (at the time) MPA sites experienced a steady decline, as the protected areas saw increases in abundance. If you stop in 2001, this is a fairly standard story about fishery effects – however, the interesting part of this species’ trend is that, rather than staying relatively consistent, as it appears to pre-fishery, the inside-MPAs experience an initial increase, followed by a decline approximately to the level of the new MPAs, while the new MPAs are beginning to show an increase in density, and the outside reserve sites continue to decline. For many marine species that have a long larval period, recruitment is not very site-specific, and larval connectivity in the metapopulation as a whole is important for recruitment and population consistency, so this trend is likely due to overall reductions in larval abundance available for recruitment, due to smaller spawning populations outside MPAs. While the new MPAs also show signs of resilience and recovery in this case, warty sea cucumbers highlight the importance of these interconnected communities inside and outside MPAs, and thus that conditions and events outside of MPAs are still capable of affecting those inside.

# Literature Cited

Canty A, Ripley BD (2020). boot: Bootstrap R (S-Plus) Functions. R package version 1.3-25.

Davison AC, Hinkley DV (1997). Bootstrap Methods and Their Applications. Cambridge University Press, Cambridge. ISBN 0-521-57391-2, http://statwww.epfl.ch/davison/BMA/.

De Caceres, M., Legendre, P. (2009). Associations between species and groups of sites: indices and statistical inference. Ecology, URL
http://sites.google.com/site/miqueldecaceres/ 

Douglas Bates, Martin Maechler, Ben Bolker, Steve Walker (2015). Fitting Linear Mixed-Effects Models Using lme4. Journal of Statistical Software, 67(1),
1-48. doi:10.18637/jss.v067.i01.

Dufrêne, M. & Legendre, P. (1997) Species assemblages and indicator species: the need for a flexible asymmetrical approach. Ecological Monographs, 67, 345–366.
Rassweiler et al 2018 - conversions to kelp biomass

McGeoch, M.A. & Chown, S.L. (1998) Scaling up the value of bioindicators. Trends in Ecology & Evolution, 13, 46–47.

Jari Oksanen, F. Guillaume Blanchet, Michael Friendly, Roeland Kindt, Pierre Legendre, Dan McGlinn, Peter R. Minchin, R. B. O'Hara, Gavin L. Simpson, Peter
Solymos, M. Henry H. Stevens, Eduard Szoecs and Helene Wagner (2019). vegan: Community Ecology Package. R package version 2.5-6.
https://CRAN.R-project.org/package=vegan

NEED TO CITE

+ ONI data
+ PDO data ? if we use it
+ PISCO fish data 2005-2006 ? if we use it

## Appendix A. Biomass Ratios

See bootstrapping description in methods. I'm sorry that we didn't make it this far with the state of our draft, but this is something fundamental that will need to be discussed compared to how these have been presented previously. Specifically, standard error allow for eyeball comparison of error bars between groups (ie are two means + ranges significantly different from each other), but NOT whether a mean/range is significantly different from a given number, which requires 95% CIs, and by grouping across multiple years the parametric assumption of independent samples is violated even when converted to log ratios, which artificially inflates the sample size since SE is SD/sqrt(sample size)). Further, since calculating ratios within a year only allows an n=4 (one ratio per island, based off the average biomass inside and outside from each pair of three sites) these result in error bars massively overestimating the range, but bootstrapping the data allows us to non-parametrically estimate the underlying distribution based on resampling individual site biomasses, not averaging averages for each level of reserve status. 

```{r Fish Biomass Ratio , warning=FALSE, message=FALSE, fig.height=11, fig.width=8.5}
Booted_Fish_Ratios <- tibble(
  CommonName = character(), SurveyYear = integer(),
  Mean_Ratio = double(), CI_plus = double(), CI_minus = double())

Fish_Biomass_Boot <- Fish_Biomass_Long %>%
  dplyr::group_by(SiteName, IslandName, CommonName, SurveyYear, ReserveStatus) %>% 
  dplyr::summarise(Mean_Biomass = sum(Mean_Biomass),
                   ScientificName = ScientificName) %>% 
  dplyr::mutate(Mean_Biomass = Mean_Biomass + mean(runif(1000, min = .99, max = 1 + 10^-100))) %>%
  dplyr::ungroup() 

for(y in unique(Fish_Biomass_Boot$SurveyYear)){
  for(s in unique(Fish_Biomass_Boot$CommonName)){
    d <- Fish_Biomass_Boot %>%
      filter(CommonName %in% s, SurveyYear %in% y) 
    output <- boot::boot(data = d, statistic = boot_ratio, R = 1000)
    ci_boot <- boot::boot.ci(boot.out = output, conf = 0.95, type = "perc")
    Booted_Fish_Ratios <- add_row(Booted_Fish_Ratios, CommonName = s, SurveyYear = y, Mean_Ratio = ci_boot$t0, CI_minus = ci_boot$percent[4], CI_plus = ci_boot$percent[5])
  }
}
Fish_Trophic_Levels_Short <- Fish_Trophic_Levels %>%
  dplyr::filter(CommonName %in% unique(Fish_Biomass_Long$CommonName)) %>% 
  dplyr::select(ScientificName, CommonName, Broad_Trophic_Level, Targeted) 

Booted_Fish_Ratios <- Booted_Fish_Ratios %>%
  dplyr::left_join(Fish_Trophic_Levels_Short) %>% 
  dplyr::arrange(desc(Targeted), Broad_Trophic_Level, CommonName) %>% 
  dplyr::mutate(Targeted = factor(Targeted),
                CommonName = factor(CommonName),
                SurveyYear = factor(SurveyYear))
i <- 1
for (name in unique(Booted_Fish_Ratios$CommonName)) {
  Fish_Ratios <- Booted_Fish_Ratios %>% 
    dplyr::filter(CommonName == name) 
  
   p1  <- ggplot2::ggplot(data = Fish_Ratios,
                        aes(x = SurveyYear, y = Mean_Ratio, color = Targeted)) +
    geom_hline(aes(yintercept = 1)) +
    geom_point(size = 3, stroke = 2, aes(shape = Targeted), fill = "blue") +
    geom_errorbar(aes(x = SurveyYear, width = .5,
                      ymin = Mean_Ratio - CI_minus,
                      ymax = Mean_Ratio + CI_plus)) +
    scale_color_manual(values = c("Targeted" = "firebrick", "Non-targeted" = "deepskyblue4")) +
    scale_shape_manual(values = c("Targeted" = 5, "Non-targeted" = 5)) +
    facet_grid(rows = vars(Targeted), space = "free", scales = "free") +
    labs(title = paste(name, " (", Fish_Ratios$Broad_Trophic_Level, ")", sep = ""),
         color = NULL, shape = NULL,
         x = NULL, y = NULL) +
    scale_y_continuous(trans = 'log10') +
    coord_cartesian(ylim = c(NA, max(Fish_Ratios$Mean_Ratio) * 1.2)) +
    Ratio_theme()
   
  unique_plotname <- paste("Fish.Ratio.", i, sep = "")
  assign(unique_plotname, p1)
  i <- i + 1
}
FR_Plot1 <- ggpubr::ggarrange(
  Fish.Ratio.1, Fish.Ratio.2, Fish.Ratio.3, Fish.Ratio.4, Fish.Ratio.5, Fish.Ratio.6,
  ncol = 1, align = "hv")
FR_Plot2 <- ggpubr::ggarrange(
  Fish.Ratio.7, Fish.Ratio.8, Fish.Ratio.9, Fish.Ratio.10, Fish.Ratio.11, Fish.Ratio.12,
  ncol = 1, align = "hv")
FR_Plot3 <- ggpubr::ggarrange(
  Fish.Ratio.13, Fish.Ratio.14, Fish.Ratio.15, Fish.Ratio.16, Fish.Ratio.17,
  ncol = 1, align = "hv")
FR_Plot4 <- ggpubr::ggarrange(
   Fish.Ratio.18, Fish.Ratio.19, Fish.Ratio.20, Fish.Ratio.21, Fish.Ratio.22, 
  ncol = 1, align = "hv")

FR_annotated1 <- ggpubr::annotate_figure(
  FR_Plot1, 
  left = ggpubr::text_grob(
    "Biomass Ratio",
    color = "black", size = 18, vjust = 1, hjust = .5, x = 0, rot = 90),
  bottom = ggpubr::text_grob(
    "Fish biomass ratios (inside/outside) across all MPA refrence sites.",
    color = "black", size = 11, hjust = 0, x = 0))
FR_annotated2 <- ggpubr::annotate_figure(
  FR_Plot2, 
  left = ggpubr::text_grob(
    "Biomass Ratio",
    color = "black", size = 18, vjust = 1, hjust = .5, x = 0, rot = 90),
  bottom = ggpubr::text_grob(
    "Fish biomass ratios (inside/outside) across all MPA refrence sites.",
    color = "black", size = 11, hjust = 0, x = 0))
FR_annotated3 <- ggpubr::annotate_figure(
  FR_Plot3, 
  left = ggpubr::text_grob(
    "Biomass Ratio",
    color = "black", size = 18, vjust = 1, hjust = .5, x = 0, rot = 90),
  bottom = ggpubr::text_grob(
    "Fish biomass ratios (inside/outside) across all MPA refrence sites.",
    color = "black", size = 11, hjust = 0, x = 0))
FR_annotated4 <- ggpubr::annotate_figure(
  FR_Plot4, 
  left = ggpubr::text_grob(
    "Biomass Ratio",
    color = "black", size = 18, vjust = 1, hjust = .5, x = 0, rot = 90),
  bottom = ggpubr::text_grob(
    "Fish biomass ratios (inside/outside) across all MPA refrence sites.",
    color = "black", size = 11, hjust = 0, x = 0))

print(FR_annotated1)
print(FR_annotated2)
print(FR_annotated3)
print(FR_annotated4)
```

```{r Benthic Biomass Ratio Plots, warning=FALSE, message=FALSE, fig.height=11, fig.width=8.5}
Benthic_Booted_Ratios <- tibble(
  ScientificName = character(), SurveyYear = integer(), 
  Mean_Ratio = double(), CI_plus = double(), CI_minus = double())

Benthic_Biomass_Boot <- Benthic_Biomass_Long %>%
  dplyr::group_by(SiteName, IslandName, ScientificName, ReserveStatus) %>%
  dplyr::mutate(Mean_Biomass = Mean_Biomass + mean(runif(1000, min = .99, max = 1 + 10^-100)),
                ScientificName = factor(ScientificName)) %>%
  dplyr::ungroup()

for(y in 2005:2019){
  d <- Benthic_Biomass_Boot %>%
      dplyr::filter(SurveyYear == y) %>%
    droplevels()
  for(s in levels(d$ScientificName)){
    d2 <- d  %>%
      dplyr::filter(ScientificName == s)
    output <- boot::boot(data = d2, statistic = boot_ratio, R = 1000)
    ci_boot <- boot::boot.ci(boot.out = output, conf = 0.95, type = "perc")
    Benthic_Booted_Ratios <- Benthic_Booted_Ratios %>%
      add_row(ScientificName = s, SurveyYear = y,
              Mean_Ratio = ci_boot$t0,
              CI_minus = ci_boot$percent[4],
              CI_plus = ci_boot$percent[5])
  }
}
Benthic_Targets <- Species_Info %>% 
  dplyr::select(ScientificName, Targeted_Broad, Trophic_Broad) %>% 
  dplyr::filter(ScientificName %in% unique(Benthic_Biomass_Boot$ScientificName)) %>% 
  dplyr::distinct(ScientificName, .keep_all = TRUE)

Benthic_Booted_Ratios <- Benthic_Booted_Ratios %>%
  dplyr::left_join(Benthic_Targets) %>% 
  dplyr::arrange(desc(Targeted_Broad), Trophic_Broad) %>% 
  dplyr::mutate(Targeted_Broad = factor(Targeted_Broad),
                SurveyYear = factor(SurveyYear))

i <- 1
for (name in unique(Benthic_Booted_Ratios$ScientificName)) {
  Benthic_Ratios <- Benthic_Booted_Ratios %>% 
    dplyr::filter(ScientificName == name) 
  
   p1  <- ggplot2::ggplot(data = Benthic_Ratios,
                        aes(x = SurveyYear, y = Mean_Ratio, color = Targeted_Broad)) +
    geom_hline(aes(yintercept = 1)) +
    geom_point(size = 3, stroke = 2, aes(shape = Targeted_Broad), fill = "blue") +
    geom_errorbar(aes(x = SurveyYear, width = .5,
                      ymin = Mean_Ratio - CI_minus,
                      ymax = Mean_Ratio + CI_plus)) +
    scale_color_manual(values = c("Targeted" = "firebrick", "Non-targeted" = "deepskyblue4")) +
    scale_shape_manual(values = c("Targeted" = 5, "Non-targeted" = 5)) +
    facet_grid(rows = vars(Targeted_Broad), space = "free", scales = "free") +
    labs(title = paste(name, " (", Benthic_Ratios$Trophic_Broad, ")", sep = ""),
         color = NULL, shape = NULL,
         x = NULL, y = NULL) +
    scale_y_continuous(trans = 'log10') +
    coord_cartesian(ylim = c(min(Benthic_Ratios$Mean_Ratio) * .5, 
                             max(Benthic_Ratios$Mean_Ratio) * 1.5)) +
    Ratio_theme()
   
  unique_plotname <- paste("Benthic.Ratio.", i, sep = "")
  assign(unique_plotname, p1)
  i <- i + 1
}
BR_Plot1 <- ggpubr::ggarrange(
  Benthic.Ratio.1, Benthic.Ratio.2, Benthic.Ratio.3, Benthic.Ratio.4, Benthic.Ratio.5,
  ncol = 1, align = "hv")
BR_Plot2 <- ggpubr::ggarrange(
  Benthic.Ratio.6, Benthic.Ratio.7, Benthic.Ratio.8, Benthic.Ratio.9, Benthic.Ratio.10,
  ncol = 1, align = "hv")
BR_Plot3 <- ggpubr::ggarrange(
  Benthic.Ratio.11, Benthic.Ratio.12, Benthic.Ratio.13, Benthic.Ratio.14, Benthic.Ratio.15, 
  ncol = 1, align = "hv")

BR_annotated1 <- ggpubr::annotate_figure(
  BR_Plot1, 
  left = ggpubr::text_grob(
    "Biomass Ratio",
    color = "black", size = 18, vjust = 1, hjust = .5, x = 0, rot = 90),
  bottom = ggpubr::text_grob(
    "Benthic biomass ratios (inside/outside) across all MPA refrence sites.",
    color = "black", size = 11, hjust = 0, x = 0))
BR_annotated2 <- ggpubr::annotate_figure(
  BR_Plot2, 
  left = ggpubr::text_grob(
    "Biomass Ratio",
    color = "black", size = 18, vjust = 1, hjust = .5, x = 0, rot = 90),
  bottom = ggpubr::text_grob(
    "Benthic biomass ratios (inside/outside) across all MPA refrence sites.",
    color = "black", size = 11, hjust = 0, x = 0))
BR_annotated3 <- ggpubr::annotate_figure(
  BR_Plot3,
  left = ggpubr::text_grob(
    "Biomass Ratio",
    color = "black", size = 18, vjust = 1, hjust = .5, x = 0, rot = 90),
  bottom = ggpubr::text_grob(
    "Benthic biomass ratios (inside/outside) across all MPA refrence sites.",
    color = "black", size = 11, hjust = 0, x = 0))

print(BR_annotated1)
print(BR_annotated2)
print(BR_annotated3)
```

# Appendix B. KFMP Metadata

Table XX. Kelp Forest Monitoring Program sampling sites information.
```{r Sites, results="asis", fig.width=5}
knitr::kable(Site_Table)
```

Appendix C. Regularly monitored species, substrate, and associated monitoring technique(s). Monitoring techniques are described in Davis et al., 1997, and Kushner and Sprague, in progress.
```{r Species on Protocols, results="asis"}
knitr::kable(Species_Protocol_Table)
```

Appendix D. Protocol survey area and minimum number of divers.
```{r Protocols, results="asis", fig.width=7}
knitr::kable(Protocol_Table)
```

Appendix E. Length to Weight Conversion Information for Biomass Calculations

Table XX. Benthic biomass length to weight equations
```{r Benthic Biomass Summary Equations}
Benthic_Equations <- Benthic_Biomass_Coversions_Latex %>% 
  dplyr::select(ScientificName, CommonName, LW_Equation) %>% 
  dplyr::filter(CommonName %in% Benthic_Biomass_Species)

knitr::kable(Benthic_Equations)
```

Table XX. Benthic biomass length to weight equation coeffecients and statistics with sources
```{r Benthic Biomass Full}
Benthic_coeffecients <- Benthic_Biomass_Coversions_Latex %>% 
  dplyr::filter(CommonName %in% Benthic_Biomass_Species)

knitr::kable(Benthic_coeffecients)
```

Table XX. Fish biomass length to weight equations
```{r Fish Biomass Summary Equations}
Fish_Equations <- Fish_Biomass_Coversions_Latex %>% 
  dplyr::select(ScientificName, CommonName, WL_Equation)

knitr::kable(Fish_Equations)
```

Table XX. Fish biomass length to weight equations with coeffecients, conversions, and sources
```{r Fish Biomass Conversions}
Fish_coeffecients <- Fish_Biomass_Coversions_Latex %>% 
  dplyr::select(ScientificName, CommonName, WL_Equation)  

knitr::kable(Fish_coeffecients)
```



